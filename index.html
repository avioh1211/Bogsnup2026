<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bogsnup - Firebase Edition</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; }
        header { background: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .guide { background: #eef7ff; padding: 15px; border-radius: 8px; border-left: 5px solid #007aff; font-size: 15px; line-height: 1.6; }
        .firebase-status { background: #34c759; color: white; padding: 8px 12px; border-radius: 6px; font-size: 13px; display: inline-block; margin-top: 10px; }
        .firebase-status.offline { background: #ff3b30; }

        .controls { background: white; padding: 20px 30px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .name-input-group { display: flex; min-width: 350px; gap: 10px; }
        .name-input-group input { padding: 10px; border: 2px solid #ddd; border-radius: 8px; flex: 1; }
        .btn-gem { padding: 10px 25px; background: #007aff; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-gem.saved { background: #34c759; }

        #adminArea { display: none; gap: 10px; border-left: 2px solid #eee; padding-left: 15px; align-items: center; }
        .admin-btn { padding: 10px 15px; background: #007aff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; }
        .btn-ai { background: #5856d6; }
        
        .progress-container { display: none; width: 100%; background: #f0f0f0; border-radius: 8px; overflow: hidden; margin-top: 10px; height: 30px; position: relative; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #007aff, #5856d6); transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 600; }
        
        .error-message { background: #ff3b30; color: white; padding: 10px 15px; border-radius: 8px; margin-top: 10px; font-size: 13px; display: none; }

        .book-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .book-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s; display: flex; flex-direction: column; cursor: pointer; text-align: center; }
        .book-card:hover { transform: translateY(-4px); }
        
        .card-img { width: 100px; height: 140px; object-fit: cover; margin: 0 auto 15px; border-radius: 4px; background: #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .book-title { font-size: 16px; font-weight: 600; margin-bottom: 2px; }
        .book-author { color: #666; font-size: 14px; margin-bottom: 5px; }
        .info-hint { font-size: 12px; color: #007aff; margin-bottom: 12px; font-style: italic; }

        .btn-direct-claim { width: 100%; padding: 10px; margin-top: 15px; border: none; border-radius: 8px; background: #007aff; color: white; font-weight: 600; cursor: pointer; }
        .btn-direct-claim.claimed { background: #ff3b30; }
        .btn-direct-claim:disabled { background: #ccc; cursor: not-allowed; }

        .claim-slots { display: flex; gap: 6px; margin-top: 10px; justify-content: center; flex-wrap: wrap; }
        .claim-slot { width: 60px; padding: 6px; background: #f8f8f8; border: 1px solid #ddd; border-radius: 6px; font-size: 10px; text-align: center; color: #666; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .claim-slot.winner { background: #ffd700; border-color: #ffa000; color: #000; font-weight: bold; }

        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 16px; padding: 30px; max-width: 500px; width: 95%; max-height: 90vh; overflow-y: auto; text-align: center; }
        .modal-img { width: 140px; height: 200px; object-fit: cover; margin: 0 auto 20px; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: block; }
        .modal-desc { margin: 15px 0; font-size: 14px; line-height: 1.5; color: #444; background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee; text-align: left; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .modal-buttons button { flex: 1; padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
        
        .winner-list-item { padding: 8px; background: #f0f0f0; margin-top: 5px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        .winner-list-item.is-winner { background: #ffd700; border: 1px solid #ffa000; font-weight: bold; }
        
        .stats-badge { display: inline-block; background: #34c759; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px; }
        .fetch-failed-badge { background: #ff9500; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px; }
        
        .admin-image-upload { display: none; margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 8px; border: 2px dashed #007aff; }
        .admin-image-upload.active { display: block; }
        .admin-image-upload input[type="url"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; }
        .admin-image-upload input[type="file"] { margin-bottom: 10px; }
        .admin-image-upload textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-family: inherit; resize: vertical; }
        .admin-image-upload button { padding: 8px 15px; background: #007aff; color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 5px; }
        .admin-image-upload button:hover { background: #0051d5; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìö Bogsnup <span style="font-size: 14px; color: #666;">‚ö° Real-time Edition</span></h1>
            <div class="guide">
                <strong>Vejledning:</strong> 1. Skriv dit navn & GEM. 2. Klik p√• bogen for info. 3. Klik "Jeg √∏nsker mig bogen her".<br>
                <em>Regel: Man kan vinde flere b√∏ger, hvis man er den eneste der har √∏nsket dem, men kun √©n bog hvor der er flere om buddet.</em><br>
                <span class="firebase-status" id="firebaseStatus">üîÑ Forbinder til Firebase...</span>
            </div>
        </header>

        <div class="controls">
            <div class="name-input-group">
                <input type="text" id="userName" placeholder="Dit navn">
                <button class="btn-gem" id="saveNameBtn" onclick="saveUserName()">GEM</button>
            </div>
            <button class="btn-gem" onclick="manualRefresh()" style="background: #5856d6;">üîÑ Genindl√¶s</button>
            <div id="adminArea">
                <input type="password" id="adminPass" placeholder="Kode">
                <button class="admin-btn" onclick="toggleAdmin()">üîì</button>
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCSVUpload(event)">
                <button class="admin-btn" onclick="document.getElementById('csvFileInput').click()" id="btnUpload" disabled>üìÅ CSV</button>
                <button class="admin-btn btn-ai" onclick="fetchAllInfo()" id="btnFetch" disabled>‚ú® Hent info</button>
                <button class="admin-btn" onclick="showFetchErrors()" id="btnErrors" disabled>‚ö†Ô∏è Vis fejl</button>
                <button class="admin-btn" style="background: #5856d6;" onclick="debugFirebase()" id="btnDebug" disabled>üîç Debug Firebase</button>
                <button class="admin-btn" onclick="runSmartLottery()" id="btnLottery" disabled>üé≤ Lodtr√¶kning</button>
                <button class="admin-btn" style="background:#ff3b30" onclick="clearAllData()" id="btnReset" disabled>üîÑ Slet Alt</button>
            </div>
        </div>
        
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar" id="progressBar">0%</div>
        </div>
        
        <div class="error-message" id="errorMessage"></div>
        
        <div class="book-grid" id="bookGrid"></div>
    </div>

    <div class="modal" id="bookModal">
        <div class="modal-content">
            <img id="modalImg" class="modal-img" src="" alt="Forside" style="display: none;">
            <h2 id="modalTitle"></h2>
            <p id="modalAuthor" style="color:#666; margin-bottom:10px;"></p>
            <div id="modalDesc" class="modal-desc"></div>
            <div id="modalClaims"></div>
            
            <div class="admin-image-upload" id="adminImageUpload">
                <h4 style="margin-bottom: 10px; color: #007aff;">üì∏ Upload forsidefoto (Admin)</h4>
                <div style="margin-bottom: 10px;">
                    <a id="googleImagesLink" href="#" target="_blank" style="color: #007aff; text-decoration: none; font-size: 13px;">
                        üîç S√∏g p√• Google Images
                    </a>
                </div>
                <input type="url" id="imageUrlInput" placeholder="Inds√¶t URL til billede">
                <input type="file" id="imageFileInput" accept="image/*">
                <div style="margin-bottom: 15px;">
                    <button onclick="uploadImageFromUrl()">Gem URL</button>
                    <button onclick="uploadImageFromFile()">Upload fil</button>
                    <button onclick="removeBookCover()" style="background: #ff3b30;">Fjern billede</button>
                </div>
                
                <hr style="margin: 15px 0; border: none; border-top: 1px solid #ddd;">
                
                <h4 style="margin-bottom: 10px; color: #007aff;">‚úèÔ∏è Rediger beskrivelse (Admin)</h4>
                <textarea id="descriptionTextarea" rows="4"></textarea>
                <div style="margin-top: 10px;">
                    <button onclick="saveManualDescription()">Gem beskrivelse</button>
                    <button onclick="clearDescription()" style="background: #ff9500;">Nulstil</button>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button id="modalActionButton" style="background:#007aff; color:white;"></button>
                <button onclick="closeModal()" style="background:#eee;">Luk</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        // TODO: Replace with your Firebase config
        const firebaseConfig = {
  apiKey: "AIzaSyB-2_DMuUGVgckSMGMrdUaKVVQQ7hhCTvU",
  authDomain: "bogsnup2026.firebaseapp.com",
  databaseURL: "https://bogsnup2026-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "bogsnup2026",
  storageBucket: "bogsnup2026.firebasestorage.app",
  messagingSenderId: "751291661929",
  appId: "1:751291661929:web:40a3ab1793184d6718acf8",
  measurementId: "G-3L1D4R8HXT"
        };

        // Initialize Firebase
        let database;
        let isFirebaseReady = false;
        
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            isFirebaseReady = true;
            updateFirebaseStatus(true);
            
            // Listen for connection state
            database.ref('.info/connected').on('value', (snapshot) => {
                updateFirebaseStatus(snapshot.val() === true);
            });
        } catch (error) {
            console.error('Firebase initialization error:', error);
            updateFirebaseStatus(false);
            alert('‚ö†Ô∏è FIREBASE KONFIGURATION MANGLER!\n\nSe FIREBASE_SETUP.md for instruktioner.');
        }

        function updateFirebaseStatus(connected) {
            const status = document.getElementById('firebaseStatus');
            if (connected) {
                status.textContent = '‚úÖ Forbundet til Firebase';
                status.className = 'firebase-status';
            } else {
                status.textContent = '‚ùå Ikke forbundet';
                status.className = 'firebase-status offline';
            }
        }

        // ============================================
        // CONSTANTS & STATE
        // ============================================
        const USER_KEY = 'shufflerUserName';
        const ADMIN_PASSWORD = 'Bogsnup2026';
        const MAX_CLAIMS_PER_BOOK = 4;
        const API_DELAY_MS = 500;

        let books = [];
        let currentBookId = null;
        let isAdminMode = false;

        // ============================================
        // FIREBASE DATA MANAGEMENT
        // ============================================
        function setupFirebaseListeners() {
            if (!isFirebaseReady) {
                console.warn('Firebase not ready, skipping listeners');
                return;
            }
            
            console.log('Setting up Firebase listeners...');
            
            // Listen for all book changes in real-time
            database.ref('books').on('value', (snapshot) => {
                const data = snapshot.val();
                console.log('Firebase data updated:', data);
                
                if (data) {
                    books = Object.keys(data).map(key => ({
                        firebaseKey: key,
                        ...data[key]
                    }));
                    console.log(`Loaded ${books.length} books from Firebase`);
                } else {
                    books = [];
                    console.log('No books in Firebase');
                }
                
                // Force UI update
                renderBooks();
                
                // Update modal if open
                if (currentBookId) {
                    const book = books.find(b => b.id === currentBookId);
                    if (book) {
                        updateModalContent(book);
                    }
                }
            }, (error) => {
                console.error('Firebase listener error:', error);
                showError('Firebase fejl: ' + error.message);
            });
            
            console.log('‚úÖ Firebase listeners active');
        }

        async function saveBookToFirebase(book) {
            if (!isFirebaseReady) {
                showError('Firebase ikke klar');
                return;
            }
            
            try {
                if (book.firebaseKey) {
                    // Update existing
                    await database.ref('books/' + book.firebaseKey).set(book);
                } else {
                    // Create new
                    const newRef = await database.ref('books').push(book);
                    book.firebaseKey = newRef.key;
                }
            } catch (error) {
                console.error('Firebase save error:', error);
                showError('Kunne ikke gemme til Firebase: ' + error.message);
            }
        }

        async function saveAllBooksToFirebase(booksArray) {
            if (!isFirebaseReady) {
                showError('Firebase ikke klar - tjek konfiguration');
                console.error('Firebase not initialized');
                return false;
            }
            
            try {
                console.log(`Saving ${booksArray.length} books to Firebase...`);
                
                const updates = {};
                booksArray.forEach(book => {
                    const key = book.firebaseKey || database.ref('books').push().key;
                    const bookData = { ...book };
                    delete bookData.firebaseKey;
                    updates['/books/' + key] = bookData;
                });
                
                await database.ref().update(updates);
                console.log(`‚úÖ Successfully saved ${booksArray.length} books to Firebase`);
                showError(`‚úÖ ${booksArray.length} b√∏ger gemt til Firebase`, 'success');
                return true;
            } catch (error) {
                console.error('Firebase batch save error:', error);
                showError('Kunne ikke gemme til Firebase: ' + error.message);
                return false;
            }
        }

        async function deleteAllBooksFromFirebase() {
            if (!isFirebaseReady) return;
            
            try {
                await database.ref('books').remove();
                books = [];
                renderBooks();
            } catch (error) {
                console.error('Firebase delete error:', error);
                showError('Kunne ikke slette fra Firebase');
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        function init() {
            console.log('Initializing Bogsnup...');
            loadUserName();
            setupEventListeners();
            
            // Wait a bit for Firebase to be ready, then setup listeners
            if (isFirebaseReady) {
                console.log('Firebase ready immediately, setting up listeners');
                setupFirebaseListeners();
            } else {
                console.log('Waiting for Firebase...');
                // Check Firebase status every 100ms for up to 5 seconds
                let attempts = 0;
                const checkInterval = setInterval(() => {
                    attempts++;
                    if (isFirebaseReady) {
                        console.log('Firebase ready after', attempts * 100, 'ms');
                        clearInterval(checkInterval);
                        setupFirebaseListeners();
                    } else if (attempts >= 50) {
                        console.error('Firebase failed to initialize after 5 seconds');
                        clearInterval(checkInterval);
                        showError('Firebase forbindelse fejlede - tjek konfiguration');
                    }
                }, 100);
            }
        }

        function setupEventListeners() {
            document.addEventListener('keydown', e => {
                if (e.shiftKey && e.key === 'L') {
                    document.getElementById('adminArea').style.display = 'flex';
                }
            });
            
            document.getElementById('bookModal').addEventListener('click', (e) => {
                if (e.target.id === 'bookModal') closeModal();
            });
        }

        function loadUserName() {
            const savedName = localStorage.getItem(USER_KEY);
            if (savedName) {
                document.getElementById('userName').value = savedName;
            }
        }

        // ============================================
        // USER MANAGEMENT
        // ============================================
        function saveUserName() {
            const input = document.getElementById('userName');
            const name = input.value.trim();
            
            if (!name) {
                showError('Skriv venligst dit navn');
                return;
            }
            
            localStorage.setItem(USER_KEY, name);
            
            const btn = document.getElementById('saveNameBtn');
            btn.textContent = '‚úì Gemt';
            btn.classList.add('saved');
            
            setTimeout(() => {
                btn.textContent = 'GEM';
                btn.classList.remove('saved');
            }, 2000);
            
            renderBooks();
        }

        // ============================================
        // ADMIN FUNCTIONS
        // ============================================
        function toggleAdmin() {
            const password = document.getElementById('adminPass').value;
            
            if (password === ADMIN_PASSWORD) {
                isAdminMode = true;
                document.querySelectorAll('.admin-btn').forEach(btn => btn.disabled = false);
                showError('Admin adgang aktiveret', 'success');
            } else {
                showError('Forkert adgangskode!');
            }
        }

        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            console.log('CSV file selected:', file.name);
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const lines = e.target.result.split('\n').filter(l => l.trim());
                    console.log(`CSV has ${lines.length} lines (including header)`);
                    
                    if (lines.length < 2) {
                        showError('CSV-filen skal indeholde mindst en overskrift og en bog');
                        return;
                    }
                    
                    const newBooks = lines.slice(1).map((line, i) => {
                        const parts = line.split(/[;,]/).map(p => p.trim());
                        return {
                            id: 'b-' + Date.now() + '-' + i,
                            title: parts[0] || 'Ingen titel',
                            author: parts[1] || 'Ukendt forfatter',
                            desc: 'Brug "Hent info" for at hente beskrivelse fra Google Books.',
                            cover: '',
                            claims: [],
                            winner: null,
                            fetchAttempted: false,
                            fetchSuccess: false,
                            manualCover: false,
                            manualDesc: false
                        };
                    });
                    
                    console.log('Parsed books:', newBooks);
                    console.log(`Uploading ${newBooks.length} books to Firebase...`);
                    
                    const success = await saveAllBooksToFirebase(newBooks);
                    
                    if (success) {
                        console.log('‚úÖ CSV upload complete!');
                    } else {
                        console.error('‚ùå CSV upload failed');
                    }
                    
                } catch (error) {
                    console.error('CSV parsing error:', error);
                    showError('Fejl ved indl√¶sning af CSV-fil: ' + error.message);
                }
            };
            
            reader.onerror = () => {
                showError('Kunne ikke l√¶se filen');
                console.error('FileReader error');
            };
            
            reader.readAsText(file);
            event.target.value = '';
        }

        async function fetchAllInfo() {
            if (books.length === 0) {
                showError('Ingen b√∏ger at hente info for. Upload f√∏rst en CSV-fil.');
                return;
            }
            
            const btn = document.getElementById('btnFetch');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Henter...';
            progressContainer.style.display = 'block';
            
            let successCount = 0;
            let failCount = 0;
            
            for (let i = 0; i < books.length; i++) {
                const book = books[i];
                
                const progress = Math.round(((i + 1) / books.length) * 100);
                progressBar.style.width = progress + '%';
                
                let skipNote = '';
                if (book.manualCover && book.manualDesc) {
                    skipNote = ' (springes over - manuel)';
                } else if (book.manualCover) {
                    skipNote = ' (kun beskrivelse)';
                } else if (book.manualDesc) {
                    skipNote = ' (kun forside)';
                }
                
                progressBar.textContent = `${i + 1}/${books.length} - ${book.title}${skipNote}`;
                
                if (book.manualCover && book.manualDesc) {
                    await delay(100);
                    continue;
                }
                
                try {
                    const queries = [
                        `intitle:"${book.title}" inauthor:"${book.author}"`,
                        `${book.title} ${book.author}`,
                        book.title
                    ];
                    
                    let bookFound = false;
                    
                    for (const query of queries) {
                        if (bookFound) break;
                        
                        try {
                            const url = `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&langRestrict=da&maxResults=3`;
                            
                            const response = await fetch(url, {
                                method: 'GET',
                                headers: { 'Accept': 'application/json' },
                                mode: 'cors',
                                cache: 'default'
                            });
                            
                            if (!response.ok) {
                                if (response.status === 429) {
                                    throw new Error('Rate limit - vent venligst');
                                }
                                throw new Error(`HTTP ${response.status}`);
                            }
                            
                            const data = await response.json();
                            
                            if (data.items && data.items.length > 0) {
                                let bestMatch = data.items[0];
                                
                                for (const item of data.items) {
                                    const itemTitle = item.volumeInfo.title || '';
                                    if (itemTitle.toLowerCase().includes(book.title.toLowerCase())) {
                                        bestMatch = item;
                                        break;
                                    }
                                }
                                
                                const info = bestMatch.volumeInfo;
                                
                                if (!book.manualDesc) {
                                    let description = '';
                                    if (info.description) {
                                        description = info.description;
                                    } else if (info.subtitle) {
                                        description = `${info.subtitle}\n\n(Ingen fuld beskrivelse tilg√¶ngelig fra Google Books)`;
                                    } else if (info.categories && info.categories.length > 0) {
                                        description = `Kategori: ${info.categories.join(', ')}\n\n(Ingen beskrivelse tilg√¶ngelig fra Google Books)`;
                                    } else {
                                        description = 'Ingen beskrivelse tilg√¶ngelig fra Google Books API.';
                                    }
                                    
                                    if (description && !description.includes('Brug "Hent info"')) {
                                        book.desc = description;
                                    }
                                }
                                
                                if (!book.manualCover && info.imageLinks) {
                                    book.cover = (info.imageLinks.large || 
                                                 info.imageLinks.medium || 
                                                 info.imageLinks.thumbnail || 
                                                 info.imageLinks.smallThumbnail || 
                                                 '').replace('http:', 'https:');
                                }
                                
                                if (info.authors && info.authors.length > 0) {
                                    book.author = info.authors.join(', ');
                                }
                                
                                book.apiData = {
                                    hasDescription: !!info.description,
                                    hasSubtitle: !!info.subtitle,
                                    hasCategories: !!(info.categories && info.categories.length > 0),
                                    title: info.title
                                };
                                
                                book.fetchSuccess = true;
                                bookFound = true;
                                successCount++;
                            }
                        } catch (queryError) {
                            console.warn(`Query attempt failed: ${query}`, queryError);
                        }
                    }
                    
                    if (!bookFound) {
                        console.warn(`No results found for: ${book.title} by ${book.author}`);
                        book.fetchError = 'Ikke fundet i Google Books';
                        failCount++;
                    }
                    
                    book.fetchAttempted = true;
                    
                    // Save to Firebase
                    await saveBookToFirebase(book);
                    
                    if (i < books.length - 1) {
                        await delay(API_DELAY_MS);
                    }
                    
                } catch (error) {
                    console.error(`Error fetching info for "${book.title}":`, error);
                    
                    if (error.message.includes('fetch') || error.message.includes('Failed to fetch')) {
                        book.fetchError = 'Netv√¶rksfejl - Google Books blokeret eller ingen forbindelse';
                    } else if (error.message.includes('Rate limit')) {
                        book.fetchError = 'Rate limit - for mange foresp√∏rgsler';
                    } else {
                        book.fetchError = error.message || 'Ukendt fejl';
                    }
                    
                    book.fetchAttempted = true;
                    failCount++;
                    
                    progressBar.textContent = `${i + 1}/${books.length} - ‚ùå ${book.title} (${book.fetchError})`;
                    
                    await saveBookToFirebase(book);
                    await delay(800);
                }
            }
            
            btn.disabled = false;
            btn.textContent = '‚ú® Hent info';
            progressContainer.style.display = 'none';
            
            if (failCount > 0) {
                showError(
                    `F√¶rdig! ‚úÖ ${successCount} b√∏ger hentet | ‚ùå ${failCount} fejlede. Klik "Vis fejl" for detaljer.`,
                    failCount === books.length ? 'error' : 'success'
                );
            } else {
                showError(
                    `üéâ Perfekt! Alle ${successCount} b√∏ger blev hentet korrekt!`,
                    'success'
                );
            }
        }

        function showFetchErrors() {
            const failedBooks = books.filter(b => b.fetchAttempted && !b.fetchSuccess);
            
            if (failedBooks.length === 0) {
                showError('Ingen fejl at vise! Alle b√∏ger blev hentet korrekt.', 'success');
                return;
            }
            
            const networkErrors = failedBooks.filter(b => b.fetchError?.includes('Netv√¶rksfejl')).length;
            
            let errorReport = `üìã FEJLRAPPORT (${failedBooks.length} b√∏ger)\n`;
            errorReport += `${'='.repeat(50)}\n\n`;
            
            if (networkErrors > 0) {
                errorReport += `‚ö†Ô∏è NETV√ÜRKSFEJL (${networkErrors} b√∏ger):\n`;
                errorReport += `Google Books API er blokeret eller utilg√¶ngelig.\n\n`;
            }
            
            errorReport += `FEJLEDE B√òGER:\n${'-'.repeat(50)}\n`;
            
            failedBooks.forEach((book, i) => {
                const hasDesc = book.desc && !book.desc.includes('Brug "Hent info"');
                errorReport += `${i + 1}. "${book.title}" af ${book.author}\n`;
                errorReport += `   Fejl: ${book.fetchError || 'Ikke fundet'}\n`;
                errorReport += `   Forside: ${book.cover ? '‚úì' : '‚úó'}${book.manualCover ? ' (Manuel)' : ''}\n`;
                errorReport += `   Beskrivelse: ${hasDesc ? '‚úì' : '‚úó'}${book.manualDesc ? ' (Manuel)' : ''}\n\n`;
            });
            
            errorReport += `\nüí° MANUEL L√òSNING:\n${'='.repeat(50)}\n`;
            errorReport += `Klik p√• en bog og upload billede/beskrivelse via admin-panelet.\n`;
            
            alert(errorReport);
        }

        async function debugFirebase() {
            let debugReport = 'üîç FIREBASE DEBUG INFORMATION\n';
            debugReport += '‚ïê'.repeat(60) + '\n\n';
            
            // Check Firebase initialization
            debugReport += '1. FIREBASE INITIALISERING:\n';
            debugReport += `   Status: ${isFirebaseReady ? '‚úÖ Initialiseret' : '‚ùå IKKE initialiseret'}\n`;
            debugReport += `   Config loaded: ${typeof firebaseConfig !== 'undefined' ? '‚úÖ Ja' : '‚ùå Nej'}\n\n`;
            
            // Check database reference
            debugReport += '2. DATABASE REFERENCE:\n';
            debugReport += `   Database object: ${database ? '‚úÖ Findes' : '‚ùå Mangler'}\n`;
            if (firebaseConfig && firebaseConfig.databaseURL) {
                debugReport += `   Database URL: ${firebaseConfig.databaseURL}\n`;
            } else {
                debugReport += `   Database URL: ‚ùå MANGLER I CONFIG\n`;
            }
            debugReport += '\n';
            
            // Check current data
            debugReport += '3. NUV√ÜRENDE DATA:\n';
            debugReport += `   B√∏ger i lokal array: ${books.length}\n`;
            
            if (isFirebaseReady) {
                try {
                    const snapshot = await database.ref('books').once('value');
                    const firebaseBooks = snapshot.val();
                    const firebaseCount = firebaseBooks ? Object.keys(firebaseBooks).length : 0;
                    debugReport += `   B√∏ger i Firebase: ${firebaseCount}\n`;
                    
                    if (firebaseCount === 0) {
                        debugReport += `   ‚ö†Ô∏è Firebase database er TOM\n`;
                        debugReport += `   ‚Üí Upload en CSV-fil for at tilf√∏je b√∏ger\n`;
                    } else if (firebaseCount !== books.length) {
                        debugReport += `   ‚ö†Ô∏è UOVERENSSTEMMELSE!\n`;
                        debugReport += `   ‚Üí Klik "üîÑ Genindl√¶s" for at synkronisere\n`;
                    }
                } catch (error) {
                    debugReport += `   ‚ùå Fejl ved l√¶sning fra Firebase: ${error.message}\n`;
                }
            } else {
                debugReport += `   ‚ùå Kan ikke tjekke Firebase (ikke forbundet)\n`;
            }
            debugReport += '\n';
            
            // Check permissions
            debugReport += '4. FIREBASE SIKKERHEDSREGLER:\n';
            if (isFirebaseReady) {
                try {
                    // Try to write a test value
                    await database.ref('test').set({ timestamp: Date.now() });
                    debugReport += `   Skrive-adgang: ‚úÖ OK\n`;
                    await database.ref('test').remove();
                    
                    // Try to read
                    await database.ref('books').once('value');
                    debugReport += `   L√¶se-adgang: ‚úÖ OK\n`;
                } catch (error) {
                    debugReport += `   ‚ùå Adgangsfejl: ${error.message}\n`;
                    debugReport += `   ‚Üí Tjek sikkerhedsregler i Firebase Console\n`;
                }
            }
            debugReport += '\n';
            
            // Troubleshooting steps
            debugReport += '5. FEJLFINDING:\n';
            debugReport += '‚îÄ'.repeat(60) + '\n';
            
            if (!isFirebaseReady) {
                debugReport += '‚ùå Firebase ikke forbundet:\n';
                debugReport += '   1. √Öbn browser console (F12)\n';
                debugReport += '   2. Kig efter fejlbeskeder\n';
                debugReport += '   3. Verificer firebaseConfig er korrekt\n';
                debugReport += '   4. Tjek om databaseURL er sat\n';
            } else if (books.length === 0) {
                debugReport += '‚ö†Ô∏è Ingen b√∏ger fundet:\n';
                debugReport += '   1. Upload en CSV-fil f√∏rst\n';
                debugReport += '   2. Tjek browser console for fejl\n';
                debugReport += '   3. Verificer CSV format (titel,forfatter)\n';
                debugReport += '   4. Pr√∏v at klikke "üîÑ Genindl√¶s"\n';
            } else {
                debugReport += '‚úÖ Alt ser godt ud!\n';
                debugReport += `   Du har ${books.length} b√∏ger klar til at hente info for.\n`;
            }
            
            console.log(debugReport);
            alert(debugReport);
        }

        async function manualRefresh() {
            if (!isFirebaseReady) {
                showError('Firebase ikke forbundet');
                return;
            }
            
            try {
                console.log('Manual refresh triggered...');
                const snapshot = await database.ref('books').once('value');
                const data = snapshot.val();
                
                if (data) {
                    books = Object.keys(data).map(key => ({
                        firebaseKey: key,
                        ...data[key]
                    }));
                    console.log(`Refreshed: ${books.length} books loaded`);
                    renderBooks();
                    showError(`‚úÖ ${books.length} b√∏ger genindl√¶st fra Firebase`, 'success');
                } else {
                    books = [];
                    renderBooks();
                    showError('Ingen b√∏ger fundet i Firebase', 'error');
                }
            } catch (error) {
                console.error('Refresh error:', error);
                showError('Kunne ikke genindl√¶se: ' + error.message);
            }
        }

        async function runSmartLottery() {
            if (books.length === 0) {
                showError('Ingen b√∏ger at tr√¶kke lod om');
                return;
            }
            
            const totalClaims = books.reduce((sum, b) => sum + (b.claims?.length || 0), 0);
            if (totalClaims === 0) {
                showError('Ingen √∏nsker er registreret endnu');
                return;
            }
            
            if (!confirm(`Vil du k√∏re lodtr√¶kningen nu?\n\nDette vil tildele vindere til alle ${books.length} b√∏ger baseret p√• ${totalClaims} √∏nsker.`)) {
                return;
            }
            
            books.forEach(b => b.winner = null);
            
            const usersWithPopularWin = new Set();
            
            books.forEach(book => {
                if (book.claims && book.claims.length === 1) {
                    book.winner = book.claims[0];
                }
            });
            
            const popularBooks = books.filter(b => b.claims && b.claims.length > 1);
            shuffleArray(popularBooks);
            
            popularBooks.forEach(book => {
                const eligibleCandidates = book.claims.filter(user => !usersWithPopularWin.has(user));
                
                if (eligibleCandidates.length > 0) {
                    const winner = eligibleCandidates[Math.floor(Math.random() * eligibleCandidates.length)];
                    book.winner = winner;
                    usersWithPopularWin.add(winner);
                } else {
                    book.winner = book.claims[Math.floor(Math.random() * book.claims.length)];
                }
            });
            
            await saveAllBooksToFirebase(books);
            
            const winners = new Set(books.filter(b => b.winner).map(b => b.winner));
            const booksWithWinners = books.filter(b => b.winner).length;
            
            showError(
                `üéâ Lodtr√¶kning fuldf√∏rt!\n${booksWithWinners} b√∏ger tildelt til ${winners.size} vindere`,
                'success'
            );
        }

        async function clearAllData() {
            if (!confirm('Er du sikker p√• at du vil slette ALLE data?\n\nDette kan ikke fortrydes!')) {
                return;
            }
            
            if (!confirm('Sidste advarsel! Al data vil blive slettet permanent.')) {
                return;
            }
            
            await deleteAllBooksFromFirebase();
            showError('Alle data er slettet', 'success');
        }

        // ============================================
        // MANUAL IMAGE/DESCRIPTION UPLOAD (ADMIN)
        // ============================================
        async function uploadImageFromUrl() {
            if (!currentBookId) return;
            
            const url = document.getElementById('imageUrlInput').value.trim();
            if (!url) {
                showError('Indtast venligst en URL');
                return;
            }
            
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                showError('URL skal starte med http:// eller https://');
                return;
            }
            
            const book = books.find(b => b.id === currentBookId);
            if (!book) return;
            
            book.cover = url;
            book.manualCover = true;
            await saveBookToFirebase(book);
            
            const img = document.getElementById('modalImg');
            img.src = url;
            img.style.display = 'block';
            
            document.getElementById('imageUrlInput').value = '';
            showError('Forsidefoto opdateret!', 'success');
        }

        async function uploadImageFromFile() {
            if (!currentBookId) return;
            
            const fileInput = document.getElementById('imageFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('V√¶lg venligst en fil');
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                showError('Filen skal v√¶re et billede');
                return;
            }
            
            if (file.size > 2 * 1024 * 1024) {
                showError('Billedet m√• maks v√¶re 2MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const book = books.find(b => b.id === currentBookId);
                if (!book) return;
                
                book.cover = e.target.result;
                book.manualCover = true;
                await saveBookToFirebase(book);
                
                const img = document.getElementById('modalImg');
                img.src = e.target.result;
                img.style.display = 'block';
                
                fileInput.value = '';
                showError('Forsidefoto uploadet!', 'success');
            };
            
            reader.onerror = () => {
                showError('Kunne ikke l√¶se filen');
            };
            
            reader.readAsDataURL(file);
        }

        async function removeBookCover() {
            if (!currentBookId) return;
            
            if (!confirm('Vil du fjerne forsidebilledet fra denne bog?')) {
                return;
            }
            
            const book = books.find(b => b.id === currentBookId);
            if (!book) return;
            
            book.cover = '';
            book.manualCover = false;
            await saveBookToFirebase(book);
            
            document.getElementById('modalImg').style.display = 'none';
            showError('Forsidefoto fjernet', 'success');
        }

        async function saveManualDescription() {
            if (!currentBookId) return;
            
            const textarea = document.getElementById('descriptionTextarea');
            const newDesc = textarea.value.trim();
            
            if (!newDesc) {
                showError('Skriv venligst en beskrivelse');
                return;
            }
            
            const book = books.find(b => b.id === currentBookId);
            if (!book) return;
            
            book.desc = newDesc;
            book.manualDesc = true;
            await saveBookToFirebase(book);
            
            document.getElementById('modalDesc').textContent = newDesc;
            showError('Beskrivelse gemt!', 'success');
        }

        async function clearDescription() {
            if (!currentBookId) return;
            
            if (!confirm('Vil du nulstille beskrivelsen til standardteksten?')) {
                return;
            }
            
            const book = books.find(b => b.id === currentBookId);
            if (!book) return;
            
            book.desc = 'Brug "Hent info" for at hente beskrivelse fra Google Books.';
            book.manualDesc = false;
            await saveBookToFirebase(book);
            
            document.getElementById('modalDesc').textContent = book.desc;
            document.getElementById('descriptionTextarea').value = book.desc;
            showError('Beskrivelse nulstillet', 'success');
        }

        // ============================================
        // BOOK CLAIM MANAGEMENT
        // ============================================
        async function toggleClaim(bookId) {
            const user = document.getElementById('userName').value.trim();
            
            if (!user) {
                showError('Skriv dit navn og tryk GEM f√∏rst');
                return;
            }
            
            const book = books.find(b => b.id === bookId);
            if (!book) return;
            
            if (!book.claims) book.claims = [];
            
            const userIndex = book.claims.indexOf(user);
            
            if (userIndex > -1) {
                book.claims.splice(userIndex, 1);
                if (book.winner === user) book.winner = null;
            } else {
                if (book.claims.length >= MAX_CLAIMS_PER_BOOK) {
                    showError('Denne bog har allerede 4 √∏nsker');
                    return;
                }
                book.claims.push(user);
            }
            
            await saveBookToFirebase(book);
        }

        // ============================================
        // UI RENDERING
        // ============================================
        function renderBooks() {
            const grid = document.getElementById('bookGrid');
            const user = document.getElementById('userName').value.trim();
            
            if (books.length === 0) {
                grid.innerHTML = `
                    <div style="text-align:center; grid-column:1/-1; padding: 40px;">
                        <p style="font-size: 18px; color: #666; margin-bottom: 10px;">üìö Ingen b√∏ger endnu</p>
                        <p style="font-size: 14px; color: #999;">Upload en CSV-fil for at komme i gang (admin)</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = '';
            
            books.forEach(book => {
                const card = createBookCard(book, user);
                grid.appendChild(card);
            });
        }

        function createBookCard(book, user) {
            const card = document.createElement('div');
            card.className = 'book-card';
            card.onclick = () => openModal(book.id);
            
            const claims = book.claims || [];
            const isClaimed = user && claims.includes(user);
            const isWinner = book.winner === user;
            
            const slots = Array(MAX_CLAIMS_PER_BOOK).fill().map((_, i) => {
                const claimant = claims[i];
                const isSlotWinner = book.winner === claimant && claimant;
                return `<div class="claim-slot ${isSlotWinner ? 'winner' : ''}">${claimant || '-'} ${isSlotWinner ? 'üèÜ' : ''}</div>`;
            }).join('');
            
            const coverImg = book.cover 
                ? `<img src="${book.cover}" class="card-img" alt="${book.title}">`
                : `<div class="card-img"></div>`;
            
            const fetchFailedBadge = (book.fetchAttempted && !book.cover && !book.manualCover) 
                ? '<span class="fetch-failed-badge">‚ö†Ô∏è Ingen forside</span>' 
                : '';
            
            const manualBadge = book.manualCover 
                ? '<span class="fetch-failed-badge" style="background: #34c759;">‚úì Manuel</span>' 
                : '';
            
            let buttonClass = 'btn-direct-claim';
            let buttonText = 'Jeg √∏nsker mig bogen her';
            let buttonDisabled = false;
            
            if (!user) {
                buttonText = 'Skriv navn f√∏rst';
                buttonDisabled = true;
            } else if (isClaimed) {
                buttonClass += ' claimed';
                buttonText = 'Fjern √∏nske';
            } else if (claims.length >= MAX_CLAIMS_PER_BOOK) {
                buttonText = 'Fuld (4/4)';
                buttonDisabled = true;
            }
            
            card.innerHTML = `
                <div style="flex-grow: 1;">
                    ${coverImg}
                    <div class="book-title">${escapeHtml(book.title)}${isWinner ? ' <span class="stats-badge">üèÜ DIN</span>' : ''}${fetchFailedBadge}${manualBadge}</div>
                    <div class="book-author">${escapeHtml(book.author)}</div>
                    <div class="info-hint">‚ÑπÔ∏è Klik for beskrivelse</div>
                    <div class="claim-slots">${slots}</div>
                </div>
                <button class="${buttonClass}" 
                        ${buttonDisabled ? 'disabled' : ''} 
                        onclick="event.stopPropagation(); toggleClaim('${book.id}')">
                    ${buttonText}
                </button>
            `;
            
            return card;
        }

        function openModal(bookId) {
            currentBookId = bookId;
            const book = books.find(b => b.id === bookId);
            if (!book) return;
            
            updateModalContent(book);
            document.getElementById('bookModal').classList.add('active');
        }

        function updateModalContent(book) {
            const user = document.getElementById('userName').value.trim();
            
            const modal = document.getElementById('bookModal');
            const img = document.getElementById('modalImg');
            
            if (book.cover) {
                img.src = book.cover;
                img.style.display = 'block';
            } else {
                img.style.display = 'none';
            }
            
            document.getElementById('modalTitle').textContent = book.title;
            document.getElementById('modalAuthor').textContent = book.author;
            document.getElementById('modalDesc').textContent = book.desc || 'Ingen beskrivelse tilg√¶ngelig.';
            
            const claims = book.claims || [];
            const claimsHTML = claims.length > 0
                ? claims.map(claimant => `
                    <div class="winner-list-item ${book.winner === claimant ? 'is-winner' : ''}">
                        <span>${escapeHtml(claimant)}</span>
                        ${book.winner === claimant ? '<span>üèÜ VINDER</span>' : ''}
                    </div>
                `).join('')
                : '<p style="color: #999; font-style: italic;">Ingen √∏nsker endnu</p>';
            
            document.getElementById('modalClaims').innerHTML = claimsHTML;
            
            const actionBtn = document.getElementById('modalActionButton');
            const isClaimed = user && claims.includes(user);
            
            if (!user) {
                actionBtn.textContent = 'Skriv dit navn f√∏rst';
                actionBtn.disabled = true;
            } else if (isClaimed) {
                actionBtn.textContent = 'Fjern √∏nske';
                actionBtn.disabled = false;
            } else if (claims.length >= MAX_CLAIMS_PER_BOOK) {
                actionBtn.textContent = 'Bogen er fuld (4/4)';
                actionBtn.disabled = true;
            } else {
                actionBtn.textContent = 'Jeg √∏nsker mig bogen her';
                actionBtn.disabled = false;
            }
            
            actionBtn.onclick = () => toggleClaim(book.id);
            
            const adminUploadSection = document.getElementById('adminImageUpload');
            if (isAdminMode) {
                adminUploadSection.classList.add('active');
                document.getElementById('imageUrlInput').value = '';
                document.getElementById('imageFileInput').value = '';
                document.getElementById('descriptionTextarea').value = book.desc || '';
                
                const searchQuery = encodeURIComponent(`${book.title} ${book.author} bog forside`);
                document.getElementById('googleImagesLink').href = `https://www.google.com/search?tbm=isch&q=${searchQuery}`;
            } else {
                adminUploadSection.classList.remove('active');
            }
        }

        function closeModal() {
            document.getElementById('bookModal').classList.remove('active');
            currentBookId = null;
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function showError(message, type = 'error') {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.style.background = type === 'success' ? '#34c759' : '#ff3b30';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================
        // START APPLICATION
        // ============================================
        window.onload = init;
    </script>
</body>
</html>
