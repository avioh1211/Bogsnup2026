<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bogsnup</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; }
        header { background: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .guide { background: #eef7ff; padding: 15px; border-radius: 8px; border-left: 5px solid #007aff; font-size: 15px; line-height: 1.6; }

        .controls { background: white; padding: 20px 30px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .name-input-group { display: flex; min-width: 350px; gap: 10px; }
        .name-input-group input { padding: 10px; border: 2px solid #ddd; border-radius: 8px; flex: 1; }
        .btn-gem { padding: 10px 25px; background: #007aff; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-gem.saved { background: #34c759; }

        #adminArea { display: none; gap: 10px; border-left: 2px solid #eee; padding-left: 15px; align-items: center; }
        .admin-btn { padding: 10px 15px; background: #007aff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; }
        .btn-ai { background: #5856d6; }
        
        /* Progress bar */
        .progress-container { display: none; width: 100%; background: #f0f0f0; border-radius: 8px; overflow: hidden; margin-top: 10px; height: 30px; position: relative; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #007aff, #5856d6); transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: 600; }
        
        /* Error messages */
        .error-message { background: #ff3b30; color: white; padding: 10px 15px; border-radius: 8px; margin-top: 10px; font-size: 13px; display: none; }

        .book-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .book-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s; display: flex; flex-direction: column; cursor: pointer; text-align: center; }
        .book-card:hover { transform: translateY(-4px); }
        
        .card-img { width: 100px; height: 140px; object-fit: cover; margin: 0 auto 15px; border-radius: 4px; background: #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .book-title { font-size: 16px; font-weight: 600; margin-bottom: 2px; }
        .book-author { color: #666; font-size: 14px; margin-bottom: 5px; }
        .info-hint { font-size: 12px; color: #007aff; margin-bottom: 12px; font-style: italic; }

        .btn-direct-claim { width: 100%; padding: 10px; margin-top: 15px; border: none; border-radius: 8px; background: #007aff; color: white; font-weight: 600; cursor: pointer; }
        .btn-direct-claim.claimed { background: #ff3b30; }
        .btn-direct-claim:disabled { background: #ccc; cursor: not-allowed; }

        .claim-slots { display: flex; gap: 6px; margin-top: 10px; justify-content: center; flex-wrap: wrap; }
        .claim-slot { width: 60px; padding: 6px; background: #f8f8f8; border: 1px solid #ddd; border-radius: 6px; font-size: 10px; text-align: center; color: #666; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .claim-slot.winner { background: #ffd700; border-color: #ffa000; color: #000; font-weight: bold; }

        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 16px; padding: 30px; max-width: 500px; width: 95%; max-height: 90vh; overflow-y: auto; text-align: center; }
        .modal-img { width: 140px; height: 200px; object-fit: cover; margin: 0 auto 20px; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: block; }
        .modal-desc { margin: 15px 0; font-size: 14px; line-height: 1.5; color: #444; background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee; text-align: left; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .modal-buttons button { flex: 1; padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
        
        .winner-list-item { padding: 8px; background: #f0f0f0; margin-top: 5px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        .winner-list-item.is-winner { background: #ffd700; border: 1px solid #ffa000; font-weight: bold; }
        
        .stats-badge { display: inline-block; background: #34c759; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px; }
        
        .admin-image-upload { display: none; margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 8px; border: 2px dashed #007aff; }
        .admin-image-upload.active { display: block; }
        .admin-image-upload input[type="url"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; }
        .admin-image-upload input[type="file"] { margin-bottom: 10px; }
        .admin-image-upload button { padding: 8px 15px; background: #007aff; color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 5px; }
        .admin-image-upload button:hover { background: #0051d5; }
        .fetch-failed-badge { background: #ff9500; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìö Bogsnup</h1>
            <div class="guide">
                <strong>Vejledning:</strong> 1. Skriv dit navn & GEM. 2. Klik p√• bogen for info. 3. Klik "Jeg √∏nsker mig bogen her".<br>
                <em>Regel: Man kan vinde flere b√∏ger, hvis man er den eneste der har √∏nsket dem, men kun √©n bog hvor der er flere om buddet.</em><br>
                <small style="color: #666; margin-top: 5px; display: block;">üí° Siden henter automatisk opdateret boginfo fra GitHub. Tryk F5 for at genindl√¶se.</small>
            </div>
        </header>

        <div class="controls">
            <div class="name-input-group">
                <input type="text" id="userName" placeholder="Dit navn">
                <button class="btn-gem" id="saveNameBtn" onclick="saveUserName()">GEM</button>
            </div>
            <button class="btn-gem" onclick="manualSync()" style="background: #5856d6;">üîÑ Synkroniser</button>
            <div id="adminArea">
                <input type="password" id="adminPass" placeholder="Kode">
                <button class="admin-btn" onclick="toggleAdmin()">üîì</button>
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCSVUpload(event)">
                <button class="admin-btn" onclick="document.getElementById('csvFileInput').click()" id="btnUpload" disabled>üìÅ CSV</button>
                <button class="admin-btn btn-ai" onclick="fetchAllInfo()" id="btnFetch" disabled>‚ú® Hent info</button>
                <button class="admin-btn" onclick="showFetchErrors()" id="btnErrors" disabled>‚ö†Ô∏è Vis fejl</button>
                <button class="admin-btn" onclick="showDebugInfo()" id="btnDebug" disabled style="background: #5856d6;">üîç Debug</button>
                <button class="admin-btn" style="background: #34c759;" onclick="exportData()" id="btnExport" disabled>üì• Eksporter</button>
                <button class="admin-btn" style="background: #ff9500;" onclick="document.getElementById('importFileInput').click()" id="btnImport" disabled>üì§ Importer</button>
                <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="importData(event)">
                <button class="admin-btn" onclick="runSmartLottery()" id="btnLottery" disabled>üé≤ Lodtr√¶kning</button>
                <button class="admin-btn" style="background:#ff3b30" onclick="clearAllData()" id="btnReset" disabled>üîÑ Slet Alt</button>
            </div>
        </div>
        
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar" id="progressBar">0%</div>
        </div>
        
        <div class="error-message" id="errorMessage"></div>
        
        <div class="book-grid" id="bookGrid"></div>
    </div>

    <div class="modal" id="bookModal">
        <div class="modal-content">
            <img id="modalImg" class="modal-img" src="" alt="Forside" style="display: none;">
            <h2 id="modalTitle"></h2>
            <p id="modalAuthor" style="color:#666; margin-bottom:10px;"></p>
            <div id="modalDesc" class="modal-desc"></div>
            <div id="modalClaims"></div>
            
            <!-- Admin Image Upload Section -->
            <div class="admin-image-upload" id="adminImageUpload">
                <h4 style="margin-bottom: 10px; color: #007aff;">üì∏ Upload forsidefoto (Admin)</h4>
                <div style="margin-bottom: 10px;">
                    <a id="googleImagesLink" href="#" target="_blank" style="color: #007aff; text-decoration: none; font-size: 13px;">
                        üîç S√∏g p√• Google Images
                    </a>
                </div>
                <input type="url" id="imageUrlInput" placeholder="Inds√¶t URL til billede (f.eks. https://...)">
                <input type="file" id="imageFileInput" accept="image/*">
                <div>
                    <button onclick="uploadImageFromUrl()">Gem URL</button>
                    <button onclick="uploadImageFromFile()">Upload fil</button>
                    <button onclick="removeBookCover()" style="background: #ff3b30;">Fjern billede</button>
                </div>
                <div style="margin-top: 10px; font-size: 11px; color: #666;">
                    üí° H√∏jreklik p√• et billede i Google Images ‚Üí "Kopier billedadresse" ‚Üí Inds√¶t URL
                </div>
                
                <hr style="margin: 15px 0; border: none; border-top: 1px solid #ddd;">
                
                <h4 style="margin-bottom: 10px; color: #007aff;">‚úèÔ∏è Rediger beskrivelse (Admin)</h4>
                <textarea id="descriptionTextarea" rows="4" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-family: inherit; resize: vertical;"></textarea>
                <div style="margin-top: 10px;">
                    <button onclick="saveManualDescription()">Gem beskrivelse</button>
                    <button onclick="clearDescription()" style="background: #ff9500;">Nulstil</button>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button id="modalActionButton" style="background:#007aff; color:white;"></button>
                <button onclick="closeModal()" style="background:#eee;">Luk</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // DATA MANAGEMENT
        // ============================================
        const STORAGE_KEY = 'bookShuffleData';
        const USER_KEY = 'shufflerUserName';
        const ADMIN_PASSWORD = 'Bogsnup2026';
        const MAX_CLAIMS_PER_BOOK = 4;
        const API_DELAY_MS = 500; // Delay between API calls to avoid rate limiting

        let books = [];
        let currentBookId = null;
        let isAdminMode = false;

        // ============================================
        // INITIALIZATION
        // ============================================
        function init() {
            loadData();
            loadUserName();
            renderBooks();
            setupEventListeners();
            
            // Load shared data from GitHub Pages (async)
            loadSharedData().then(loaded => {
                if (loaded) {
                    console.log('‚úÖ Delt data indl√¶st fra GitHub Pages');
                }
            });
        }

        function setupEventListeners() {
            document.addEventListener('keydown', e => {
                if (e.shiftKey && e.key === 'L') {
                    document.getElementById('adminArea').style.display = 'flex';
                }
            });
            
            // Close modal on background click
            document.getElementById('bookModal').addEventListener('click', (e) => {
                if (e.target.id === 'bookModal') closeModal();
            });
        }

        function loadData() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                books = data ? JSON.parse(data) : [];
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Kunne ikke indl√¶se data fra browseren');
                books = [];
            }
        }

        function loadUserName() {
            const savedName = localStorage.getItem(USER_KEY);
            if (savedName) {
                document.getElementById('userName').value = savedName;
            }
        }

        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(books));
            } catch (error) {
                console.error('Error saving data:', error);
                showError('Kunne ikke gemme data');
            }
        }

        // ============================================
        // USER MANAGEMENT
        // ============================================
        function saveUserName() {
            const input = document.getElementById('userName');
            const name = input.value.trim();
            
            if (!name) {
                showError('Skriv venligst dit navn');
                return;
            }
            
            localStorage.setItem(USER_KEY, name);
            
            const btn = document.getElementById('saveNameBtn');
            btn.textContent = '‚úì Gemt';
            btn.classList.add('saved');
            
            setTimeout(() => {
                btn.textContent = 'GEM';
                btn.classList.remove('saved');
            }, 2000);
            
            renderBooks();
        }

        // ============================================
        // ADMIN FUNCTIONS
        // ============================================
        function toggleAdmin() {
            const password = document.getElementById('adminPass').value;
            
            if (password === ADMIN_PASSWORD) {
                isAdminMode = true;
                document.querySelectorAll('.admin-btn').forEach(btn => btn.disabled = false);
                showError('Admin adgang aktiveret', 'success');
            } else {
                showError('Forkert adgangskode!');
            }
        }

        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const lines = e.target.result.split('\n').filter(l => l.trim());
                    
                    if (lines.length < 2) {
                        showError('CSV-filen skal indeholde mindst en overskrift og en bog');
                        return;
                    }
                    
                    books = lines.slice(1).map((line, i) => {
                        const parts = line.split(/[;,]/).map(p => p.trim());
                        return {
                            id: 'b-' + Date.now() + '-' + i,
                            title: parts[0] || 'Ingen titel',
                            author: parts[1] || 'Ukendt forfatter',
                            desc: 'Brug "Hent info" for at hente beskrivelse fra Google Books.',
                            cover: '',
                            claims: [],
                            winner: null,
                            fetchAttempted: false,
                            fetchSuccess: false,
                            manualCover: false,
                            manualDesc: false
                        };
                    });
                    
                    saveData();
                    renderBooks();
                    showError(`${books.length} b√∏ger indl√¶st fra CSV`, 'success');
                } catch (error) {
                    console.error('CSV parsing error:', error);
                    showError('Fejl ved indl√¶sning af CSV-fil');
                }
            };
            
            reader.onerror = () => {
                showError('Kunne ikke l√¶se filen');
            };
            
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        async function fetchAllInfo() {
            if (books.length === 0) {
                showError('Ingen b√∏ger at hente info for. Upload f√∏rst en CSV-fil.');
                return;
            }
            
            const btn = document.getElementById('btnFetch');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Henter...';
            progressContainer.style.display = 'block';
            
            let successCount = 0;
            let failCount = 0;
            
            for (let i = 0; i < books.length; i++) {
                const book = books[i];
                
                const progress = Math.round(((i + 1) / books.length) * 100);
                progressBar.style.width = progress + '%';
                
                // Show what will be updated
                let skipNote = '';
                if (book.manualCover && book.manualDesc) {
                    skipNote = ' (springes over - manuel)';
                } else if (book.manualCover) {
                    skipNote = ' (kun beskrivelse)';
                } else if (book.manualDesc) {
                    skipNote = ' (kun forside)';
                }
                
                progressBar.textContent = `${i + 1}/${books.length} - ${book.title}${skipNote}`;
                
                // Skip entirely if both are manual
                if (book.manualCover && book.manualDesc) {
                    await delay(100);
                    continue;
                }
                
                try {
                    // Try multiple query variations for better results
                    const queries = [
                        `intitle:"${book.title}" inauthor:"${book.author}"`,
                        `${book.title} ${book.author}`,
                        book.title
                    ];
                    
                    let bookFound = false;
                    
                    for (const query of queries) {
                        if (bookFound) break;
                        
                        try {
                            const url = `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&langRestrict=da&maxResults=3`;
                            
                            const response = await fetch(url, {
                                method: 'GET',
                                headers: {
                                    'Accept': 'application/json',
                                },
                                mode: 'cors',
                                cache: 'default'
                            });
                            
                            if (!response.ok) {
                                if (response.status === 429) {
                                    throw new Error('Rate limit - vent venligst');
                                }
                                throw new Error(`HTTP ${response.status}`);
                            }
                            
                            const data = await response.json();
                            
                            if (data.items && data.items.length > 0) {
                                // Find best match
                                let bestMatch = data.items[0];
                                
                                // Try to find exact title match
                                for (const item of data.items) {
                                    const itemTitle = item.volumeInfo.title || '';
                                    if (itemTitle.toLowerCase().includes(book.title.toLowerCase())) {
                                        bestMatch = item;
                                        break;
                                    }
                                }
                                
                                const info = bestMatch.volumeInfo;
                                
                                // Update description with better fallbacks (only if not manually set)
                                if (!book.manualDesc) {
                                    let description = '';
                                    if (info.description) {
                                        description = info.description;
                                    } else if (info.subtitle) {
                                        description = `${info.subtitle}\n\n(Ingen fuld beskrivelse tilg√¶ngelig fra Google Books)`;
                                    } else if (info.categories && info.categories.length > 0) {
                                        description = `Kategori: ${info.categories.join(', ')}\n\n(Ingen beskrivelse tilg√¶ngelig fra Google Books)`;
                                    } else {
                                        description = 'Ingen beskrivelse tilg√¶ngelig fra Google Books API.';
                                    }
                                    
                                    // Only update if we got something better than the placeholder
                                    if (description && !description.includes('Brug "Hent info"')) {
                                        book.desc = description;
                                    }
                                }
                                
                                // Update cover image (only if not manually set)
                                if (!book.manualCover && info.imageLinks) {
                                    // Use larger image if available
                                    book.cover = (info.imageLinks.large || 
                                                 info.imageLinks.medium || 
                                                 info.imageLinks.thumbnail || 
                                                 info.imageLinks.smallThumbnail || 
                                                 '').replace('http:', 'https:');
                                }
                                
                                // Also update author if we got better info
                                if (info.authors && info.authors.length > 0) {
                                    book.author = info.authors.join(', ');
                                }
                                
                                // Store what we found for debugging
                                book.apiData = {
                                    hasDescription: !!info.description,
                                    hasSubtitle: !!info.subtitle,
                                    hasCategories: !!(info.categories && info.categories.length > 0),
                                    title: info.title
                                };
                                
                                book.fetchSuccess = true;
                                bookFound = true;
                                successCount++;
                            }
                        } catch (queryError) {
                            console.warn(`Query attempt failed: ${query}`, queryError);
                            // Continue to next query variation
                        }
                    }
                    
                    if (!bookFound) {
                        console.warn(`No results found for: ${book.title} by ${book.author}`);
                        book.fetchError = 'Ikke fundet i Google Books';
                        failCount++;
                    }
                    
                    book.fetchAttempted = true;
                    
                    // Save progress after each book
                    saveData();
                    
                    // Add delay between requests to avoid rate limiting
                    if (i < books.length - 1) {
                        await delay(API_DELAY_MS);
                    }
                    
                } catch (error) {
                    console.error(`Error fetching info for "${book.title}":`, error);
                    
                    // Store error message for debugging
                    if (error.message.includes('fetch') || error.message.includes('Failed to fetch')) {
                        book.fetchError = 'Netv√¶rksfejl - Google Books blokeret eller ingen forbindelse';
                    } else if (error.message.includes('Rate limit')) {
                        book.fetchError = 'Rate limit - for mange foresp√∏rgsler';
                    } else {
                        book.fetchError = error.message || 'Ukendt fejl';
                    }
                    
                    book.fetchAttempted = true;
                    failCount++;
                    
                    // Update progress bar to show error
                    progressBar.textContent = `${i + 1}/${books.length} - ‚ùå ${book.title} (${book.fetchError})`;
                    
                    // Brief pause to show error
                    await delay(800);
                }
            }
            
            // Final update
            saveData();
            renderBooks();
            
            btn.disabled = false;
            btn.textContent = '‚ú® Hent info';
            progressContainer.style.display = 'none';
            
            if (failCount > 0) {
                showError(
                    `F√¶rdig! ‚úÖ ${successCount} b√∏ger hentet | ‚ùå ${failCount} fejlede. Klik "Vis fejl" for detaljer.`,
                    failCount === books.length ? 'error' : 'success'
                );
            } else {
                showError(
                    `üéâ Perfekt! Alle ${successCount} b√∏ger blev hentet korrekt!`,
                    'success'
                );
            }
        }

        function showFetchErrors() {
            const failedBooks = books.filter(b => b.fetchAttempted && !b.fetchSuccess);
            
            if (failedBooks.length === 0) {
                showError('Ingen fejl at vise! Alle b√∏ger blev hentet korrekt.', 'success');
                return;
            }
            
            // Count error types
            const networkErrors = failedBooks.filter(b => b.fetchError?.includes('Netv√¶rksfejl')).length;
            const notFoundErrors = failedBooks.filter(b => b.fetchError?.includes('Ikke fundet')).length;
            const otherErrors = failedBooks.length - networkErrors - notFoundErrors;
            
            let errorReport = `üìã FEJLRAPPORT (${failedBooks.length} b√∏ger)\n`;
            errorReport += `${'='.repeat(50)}\n\n`;
            
            if (networkErrors > 0) {
                errorReport += `‚ö†Ô∏è NETV√ÜRKSFEJL (${networkErrors} b√∏ger):\n`;
                errorReport += `Google Books API er blokeret eller utilg√¶ngelig.\n\n`;
                errorReport += `L√òSNINGER:\n`;
                errorReport += `‚Ä¢ Check din internetforbindelse\n`;
                errorReport += `‚Ä¢ Pr√∏v fra en anden browser (Chrome/Firefox)\n`;
                errorReport += `‚Ä¢ Pr√∏v fra en anden netv√¶rk/WiFi\n`;
                errorReport += `‚Ä¢ Brug VPN hvis API er blokeret\n`;
                errorReport += `‚Ä¢ Upload forsider manuelt (se nedenfor)\n\n`;
            }
            
            errorReport += `FEJLEDE B√òGER:\n`;
            errorReport += `${'-'.repeat(50)}\n`;
            
            failedBooks.forEach((book, i) => {
                const hasDesc = book.desc && !book.desc.includes('Brug "Hent info"') && !book.desc.includes('Ingen beskrivelse');
                errorReport += `${i + 1}. "${book.title}" af ${book.author}\n`;
                errorReport += `   Fejl: ${book.fetchError || 'Ikke fundet'}\n`;
                errorReport += `   Forside: ${book.cover ? '‚úì Ja' : '‚úó Nej'}${book.manualCover ? ' (Manuel)' : ''}\n`;
                errorReport += `   Beskrivelse: ${hasDesc ? '‚úì Ja' : '‚úó Nej'}${book.manualDesc ? ' (Manuel)' : ''}\n\n`;
            });
            
            errorReport += `\nüí° MANUEL L√òSNING:\n`;
            errorReport += `${'='.repeat(50)}\n`;
            errorReport += `1. Klik p√• en bog uden forside\n`;
            errorReport += `2. Klik p√• "üîç S√∏g p√• Google Images"\n`;
            errorReport += `3. H√∏jreklik p√• forsidebilledet ‚Üí "Kopier billedadresse"\n`;
            errorReport += `4. Inds√¶t URL'en og klik "Gem URL"\n`;
            errorReport += `\nEller upload fra din computer!\n`;
            
            alert(errorReport);
        }

        function showDebugInfo() {
            const fetchedBooks = books.filter(b => b.fetchAttempted);
            
            if (fetchedBooks.length === 0) {
                showError('Ingen b√∏ger er hentet endnu. Klik "Hent info" f√∏rst.', 'error');
                return;
            }
            
            let debugReport = `üîç DEBUG INFORMATION (${fetchedBooks.length} b√∏ger)\n`;
            debugReport += `${'='.repeat(60)}\n\n`;
            
            const withDesc = fetchedBooks.filter(b => b.apiData?.hasDescription).length;
            const withSubtitle = fetchedBooks.filter(b => b.apiData?.hasSubtitle).length;
            const withCategories = fetchedBooks.filter(b => b.apiData?.hasCategories).length;
            const withCover = fetchedBooks.filter(b => b.cover && !b.manualCover).length;
            
            debugReport += `üìä STATISTIK:\n`;
            debugReport += `Fuld beskrivelse fra API: ${withDesc}/${fetchedBooks.length}\n`;
            debugReport += `Undertitel fundet: ${withSubtitle}/${fetchedBooks.length}\n`;
            debugReport += `Kategorier fundet: ${withCategories}/${fetchedBooks.length}\n`;
            debugReport += `Forsidebilleder fra API: ${withCover}/${fetchedBooks.length}\n\n`;
            
            debugReport += `üìã DETALJER:\n`;
            debugReport += `${'-'.repeat(60)}\n`;
            
            fetchedBooks.forEach((book, i) => {
                const hasRealDesc = book.desc && !book.desc.includes('Brug "Hent info"') && !book.desc.includes('Ingen beskrivelse');
                debugReport += `${i + 1}. "${book.title}"\n`;
                if (book.apiData) {
                    debugReport += `   API Titel: ${book.apiData.title || 'N/A'}\n`;
                    debugReport += `   Beskrivelse: ${book.apiData.hasDescription ? '‚úì' : '‚úó'}\n`;
                    debugReport += `   Undertitel: ${book.apiData.hasSubtitle ? '‚úì' : '‚úó'}\n`;
                    debugReport += `   Kategorier: ${book.apiData.hasCategories ? '‚úì' : '‚úó'}\n`;
                } else {
                    debugReport += `   ‚ùå Ingen API data\n`;
                }
                debugReport += `   Forside: ${book.cover ? '‚úì' : '‚úó'}${book.manualCover ? ' (Manuel)' : ''}\n`;
                debugReport += `   Beskrivelse gemt: ${hasRealDesc ? '‚úì' : '‚úó'}${book.manualDesc ? ' (Manuel)' : ''}\n`;
                debugReport += `   Success: ${book.fetchSuccess ? '‚úì' : '‚úó'}\n`;
                if (book.fetchError) {
                    debugReport += `   Fejl: ${book.fetchError}\n`;
                }
                debugReport += `\n`;
            });
            
            debugReport += `\nüí° HVIS BESKRIVELSER MANGLER:\n`;
            debugReport += `${'='.repeat(60)}\n`;
            debugReport += `‚Ä¢ Mange danske b√∏ger har ingen beskrivelse i Google Books API\n`;
            debugReport += `‚Ä¢ Du kan redigere beskrivelser manuelt i admin-panelet\n`;
            debugReport += `‚Ä¢ Klik p√• en bog ‚Üí "‚úèÔ∏è Rediger beskrivelse"\n`;
            
            console.log(debugReport);
            alert(debugReport);
        }

        // ============================================
        // DATA SHARING (EXPORT/IMPORT) - GITHUB PAGES
        // ============================================
        function exportData() {
            if (books.length === 0) {
                showError('Ingen data at eksportere');
                return;
            }
            
            const dataToExport = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                books: books
            };
            
            const jsonString = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `data.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            const booksWithDesc = books.filter(b => b.desc && !b.desc.includes('Brug "Hent info"')).length;
            const booksWithCover = books.filter(b => b.cover).length;
            
            showError(`‚úÖ data.json eksporteret! ${books.length} b√∏ger`, 'success');
            
            // Show GitHub instructions
            setTimeout(() => {
                const instructions = `üì§ DATA EKSPORTERET SOM: data.json\n\n` +
                      `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n` +
                      `S√ÖDAN DELER DU DATA MED ALLE BRUGERE:\n` +
                      `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n` +
                      `1. √Öbn din GitHub repository:\n` +
                      `   https://github.com/avioh1211/Bogsnup2026\n\n` +
                      `2. Upload data.json:\n` +
                      `   ‚Ä¢ Klik "Add file" ‚Üí "Upload files"\n` +
                      `   ‚Ä¢ Tr√¶k data.json filen ind\n` +
                      `   ‚Ä¢ Skriv commit besked: "Opdater bogdata"\n` +
                      `   ‚Ä¢ Klik "Commit changes"\n\n` +
                      `3. Vent 1-2 minutter p√• GitHub Pages deployment\n\n` +
                      `4. F√ÜRDIG! Alle brugere f√•r automatisk:\n` +
                      `   ‚Ä¢ Alle ${books.length} b√∏ger\n` +
                      `   ‚Ä¢ ${booksWithCover} forsidebilleder\n` +
                      `   ‚Ä¢ ${booksWithDesc} beskrivelser\n\n` +
                      `Brugernes √∏nsker bliver BEVARET n√•r data opdateres!\n\n` +
                      `TIP: Hver gang du √¶ndrer noget som admin,\n` +
                      `eksporter data.json igen og upload til GitHub.`;
                
                alert(instructions);
            }, 500);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.books || !Array.isArray(data.books)) {
                        throw new Error('Ugyldig data format');
                    }
                    
                    mergeImportedData(data.books);
                    
                } catch (error) {
                    console.error('Import error:', error);
                    showError('Kunne ikke importere data: ' + error.message);
                }
            };
            
            reader.onerror = () => {
                showError('Kunne ikke l√¶se filen');
            };
            
            reader.readAsText(file);
            event.target.value = '';
        }

        async function loadSharedData() {
            // Try to load shared data from GitHub Pages
            const dataURL = './data.json?' + Date.now(); // Add cache buster
            
            try {
                const response = await fetch(dataURL);
                
                if (!response.ok) {
                    // No shared data file exists yet
                    console.log('No shared data.json found - using local data only');
                    return false;
                }
                
                const data = await response.json();
                
                if (!data.books || !Array.isArray(data.books)) {
                    throw new Error('Ugyldig data format');
                }
                
                console.log(`Loaded ${data.books.length} books from shared data.json`);
                mergeImportedData(data.books, true);
                
                return true;
                
            } catch (error) {
                if (error.message.includes('JSON')) {
                    console.error('Invalid JSON in data.json:', error);
                    showError('data.json indeholder fejl - kontakt admin');
                } else {
                    // File doesn't exist or network error - this is OK
                    console.log('Shared data not available:', error.message);
                }
                return false;
            }
        }

        function mergeImportedData(importedBooks, silent = false) {
            const oldBooks = books;
            
            // Merge: Keep user claims, update book info
            books = importedBooks.map(importedBook => {
                const existingBook = oldBooks.find(b => 
                    b.title === importedBook.title && b.author === importedBook.author
                );
                
                if (existingBook) {
                    // Preserve user's claims and winner
                    return {
                        ...importedBook,
                        claims: existingBook.claims || [],
                        winner: existingBook.winner || null
                    };
                }
                
                return importedBook;
            });
            
            saveData();
            renderBooks();
            
            if (!silent) {
                const booksWithDesc = books.filter(b => b.desc && !b.desc.includes('Brug "Hent info"')).length;
                const booksWithCover = books.filter(b => b.cover).length;
                
                showError(
                    `‚úÖ Data opdateret!\n${books.length} b√∏ger | ${booksWithCover} forsider | ${booksWithDesc} beskrivelser`,
                    'success'
                );
            }
        }

        async function manualSync() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Synkroniserer...';
            
            const loaded = await loadSharedData();
            
            btn.disabled = false;
            btn.textContent = 'üîÑ Synkroniser';
            
            if (!loaded) {
                showError('Ingen opdateringer fundet p√• serveren');
            }
        }

        function runSmartLottery() {
            if (books.length === 0) {
                showError('Ingen b√∏ger at tr√¶kke lod om');
                return;
            }
            
            const totalClaims = books.reduce((sum, b) => sum + b.claims.length, 0);
            if (totalClaims === 0) {
                showError('Ingen √∏nsker er registreret endnu');
                return;
            }
            
            if (!confirm(`Vil du k√∏re lodtr√¶kningen nu?\n\nDette vil tildele vindere til alle ${books.length} b√∏ger baseret p√• ${totalClaims} √∏nsker.`)) {
                return;
            }
            
            // Reset all winners
            books.forEach(b => b.winner = null);
            
            const usersWithPopularWin = new Set();
            
            // Phase 1: Assign books with only 1 claim (guaranteed wins)
            books.forEach(book => {
                if (book.claims.length === 1) {
                    book.winner = book.claims[0];
                }
            });
            
            // Phase 2: Lottery for books with multiple claims
            const popularBooks = books.filter(b => b.claims.length > 1);
            
            // Shuffle to make the process fair
            shuffleArray(popularBooks);
            
            popularBooks.forEach(book => {
                // Find candidates who haven't won a popular book yet
                const eligibleCandidates = book.claims.filter(user => !usersWithPopularWin.has(user));
                
                if (eligibleCandidates.length > 0) {
                    // Pick random winner from eligible candidates
                    const winner = eligibleCandidates[Math.floor(Math.random() * eligibleCandidates.length)];
                    book.winner = winner;
                    usersWithPopularWin.add(winner);
                } else {
                    // Fallback: if everyone has already won, pick from all claims
                    book.winner = book.claims[Math.floor(Math.random() * book.claims.length)];
                }
            });
            
            saveData();
            renderBooks();
            
            // Calculate statistics
            const winners = new Set(books.filter(b => b.winner).map(b => b.winner));
            const booksWithWinners = books.filter(b => b.winner).length;
            
            showError(
                `üéâ Lodtr√¶kning fuldf√∏rt!\n${booksWithWinners} b√∏ger tildelt til ${winners.size} vindere`,
                'success'
            );
        }

        function clearAllData() {
            if (!confirm('Er du sikker p√• at du vil slette ALLE data?\n\nDette kan ikke fortrydes!')) {
                return;
            }
            
            if (!confirm('Sidste advarsel! Al data vil blive slettet permanent.')) {
                return;
            }
            
            books = [];
            saveData();
            renderBooks();
            showError('Alle data er slettet', 'success');
        }

        // ============================================
        // MANUAL IMAGE UPLOAD (ADMIN)
        // ============================================
        function uploadImageFromUrl() {
            if (!currentBookId) return;
            
            const url = document.getElementById('imageUrlInput').value.trim();
            if (!url) {
                showError('Indtast venligst en URL');
                return;
            }
            
            // Basic URL validation
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                showError('URL skal starte med http:// eller https://');
                return;
            }
            
            const book = books.find(b => b.id === currentBookId);
            if (!book) return;
            
            book.cover = url;
            book.manualCover = true;
            saveData();
            renderBooks();
            
            // Update modal image
            const img = document.getElementById('modalImg');
            img.src = url;
            img.style.display = 'block';
            
            // Clear input
            document.getElementById('imageUrlInput').value = '';
            
            showError('Forsidefoto opdateret!', 'success');
        }

        function uploadImageFromFile() {
            if (!currentBookId) return;
            
            const fileInput = document.getElementById('imageFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('V√¶lg venligst en fil');
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                showError('Filen skal v√¶re et billede');
                return;
            }
            
            // Check file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showError('Billedet m√• maks v√¶re 2MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const book = books.find(b => b.id === currentBookId);
                if (!book) return;
                
                book.cover = e.target.result; // Base64 data URL
                book.manualCover = true;
                saveData();
                renderBooks();
                
                // Update modal image
                const img = document.getElementById('modalImg');
                img.src = e.target.result;
                img.style.display = 'block';
                
                // Clear input
                fileInput.value = '';
                
                showError('Forsidefoto uploadet!', 'success');
            };
            
            reader.onerror = () => {
                showError('Kunne ikke l√¶se filen');
            };
            
            reader.readAsDataURL(file);
        }

        function removeBookCover() {
            if (!currentBookId) return;
            
            if (!confirm('Vil du fjerne forsidebilledet fra denne bog?')) {
                return;
            }
            
            const book = books.find(b => b.id === currentBookId);
            if (!book) return;
            
            book.cover = '';
            book.manualCover = false;
            saveData();
            renderBooks();
            
            // Update modal image
            const img = document.getElementById('modalImg');
            img.style.display = 'none';
            
            showError('Forsidefoto fjernet', 'success');
        }

        function saveManualDescription() {
            if (!currentBookId) return;
            
            const textarea = document.getElementById('descriptionTextarea');
            const newDesc = textarea.value.trim();
            
            if (!newDesc) {
                showError('Skriv venligst en beskrivelse');
                return;
            }
            
            const book = books.find(b => b.id === currentBookId);
            if (!book) return;
            
            book.desc = newDesc;
            book.manualDesc = true;
            saveData();
            renderBooks();
            
            // Update modal description
            document.getElementById('modalDesc').textContent = newDesc;
            
            showError('Beskrivelse gemt!', 'success');
        }

        function clearDescription() {
            if (!currentBookId) return;
            
            if (!confirm('Vil du nulstille beskrivelsen til standardteksten?')) {
                return;
            }
            
            const book = books.find(b => b.id === currentBookId);
            if (!book) return;
            
            book.desc = 'Brug "Hent info" for at hente beskrivelse fra Google Books.';
            book.manualDesc = false;
            saveData();
            renderBooks();
            
            // Update modal
            document.getElementById('modalDesc').textContent = book.desc;
            document.getElementById('descriptionTextarea').value = book.desc;
            
            showError('Beskrivelse nulstillet', 'success');
        }

        // ============================================
        // BOOK MANAGEMENT
        // ============================================
        function toggleClaim(bookId) {
            const user = document.getElementById('userName').value.trim();
            
            if (!user) {
                showError('Skriv dit navn og tryk GEM f√∏rst');
                return;
            }
            
            const book = books.find(b => b.id === bookId);
            if (!book) return;
            
            const userIndex = book.claims.indexOf(user);
            
            if (userIndex > -1) {
                // Remove claim
                book.claims.splice(userIndex, 1);
                
                // Remove winner status if applicable
                if (book.winner === user) {
                    book.winner = null;
                }
            } else {
                // Add claim
                if (book.claims.length >= MAX_CLAIMS_PER_BOOK) {
                    showError('Denne bog har allerede 4 √∏nsker');
                    return;
                }
                book.claims.push(user);
            }
            
            saveData();
            renderBooks();
            
            // Update modal if it's open
            if (currentBookId === bookId) {
                openModal(bookId);
            }
        }

        // ============================================
        // UI RENDERING
        // ============================================
        function renderBooks() {
            const grid = document.getElementById('bookGrid');
            const user = document.getElementById('userName').value.trim();
            
            if (books.length === 0) {
                grid.innerHTML = `
                    <div style="text-align:center; grid-column:1/-1; padding: 40px;">
                        <p style="font-size: 18px; color: #666; margin-bottom: 10px;">üìö Ingen b√∏ger endnu</p>
                        <p style="font-size: 14px; color: #999;">Upload en CSV-fil for at komme i gang</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = '';
            
            books.forEach(book => {
                const card = createBookCard(book, user);
                grid.appendChild(card);
            });
        }

        function createBookCard(book, user) {
            const card = document.createElement('div');
            card.className = 'book-card';
            card.onclick = () => openModal(book.id);
            
            const isClaimed = user && book.claims.includes(user);
            const isWinner = book.winner === user;
            
            // Create claim slots
            const slots = Array(MAX_CLAIMS_PER_BOOK).fill().map((_, i) => {
                const claimant = book.claims[i];
                const isSlotWinner = book.winner === claimant && claimant;
                return `<div class="claim-slot ${isSlotWinner ? 'winner' : ''}">${claimant || '-'} ${isSlotWinner ? 'üèÜ' : ''}</div>`;
            }).join('');
            
            // Create cover image or placeholder
            const coverImg = book.cover 
                ? `<img src="${book.cover}" class="card-img" alt="${book.title}">`
                : `<div class="card-img"></div>`;
            
            // Show indicator if fetch was attempted but no cover found
            const fetchFailedBadge = (book.fetchAttempted && !book.cover && !book.manualCover) 
                ? '<span class="fetch-failed-badge">‚ö†Ô∏è Ingen forside</span>' 
                : '';
            
            // Show manual badge if cover was manually added
            const manualBadge = book.manualCover 
                ? '<span class="fetch-failed-badge" style="background: #34c759;">‚úì Manuel</span>' 
                : '';
            
            // Determine button state
            let buttonClass = 'btn-direct-claim';
            let buttonText = 'Jeg √∏nsker mig bogen her';
            let buttonDisabled = false;
            
            if (!user) {
                buttonText = 'Skriv navn f√∏rst';
                buttonDisabled = true;
            } else if (isClaimed) {
                buttonClass += ' claimed';
                buttonText = 'Fjern √∏nske';
            } else if (book.claims.length >= MAX_CLAIMS_PER_BOOK) {
                buttonText = 'Fuld (4/4)';
                buttonDisabled = true;
            }
            
            card.innerHTML = `
                <div style="flex-grow: 1;">
                    ${coverImg}
                    <div class="book-title">${escapeHtml(book.title)}${isWinner ? ' <span class="stats-badge">üèÜ DIN</span>' : ''}${fetchFailedBadge}${manualBadge}</div>
                    <div class="book-author">${escapeHtml(book.author)}</div>
                    <div class="info-hint">‚ÑπÔ∏è Klik for beskrivelse</div>
                    <div class="claim-slots">${slots}</div>
                </div>
                <button class="${buttonClass}" 
                        ${buttonDisabled ? 'disabled' : ''} 
                        onclick="event.stopPropagation(); toggleClaim('${book.id}')">
                    ${buttonText}
                </button>
            `;
            
            return card;
        }

        function openModal(bookId) {
            currentBookId = bookId;
            const book = books.find(b => b.id === bookId);
            if (!book) return;
            
            const user = document.getElementById('userName').value.trim();
            
            const modal = document.getElementById('bookModal');
            const img = document.getElementById('modalImg');
            
            // Set cover image
            if (book.cover) {
                img.src = book.cover;
                img.style.display = 'block';
            } else {
                img.style.display = 'none';
            }
            
            // Set book details
            document.getElementById('modalTitle').textContent = book.title;
            document.getElementById('modalAuthor').textContent = book.author;
            document.getElementById('modalDesc').textContent = book.desc;
            
            // Render claims list
            const claimsHTML = book.claims.length > 0
                ? book.claims.map(claimant => `
                    <div class="winner-list-item ${book.winner === claimant ? 'is-winner' : ''}">
                        <span>${escapeHtml(claimant)}</span>
                        ${book.winner === claimant ? '<span>üèÜ VINDER</span>' : ''}
                    </div>
                `).join('')
                : '<p style="color: #999; font-style: italic;">Ingen √∏nsker endnu</p>';
            
            document.getElementById('modalClaims').innerHTML = claimsHTML;
            
            // Set action button
            const actionBtn = document.getElementById('modalActionButton');
            const isClaimed = user && book.claims.includes(user);
            
            if (!user) {
                actionBtn.textContent = 'Skriv dit navn f√∏rst';
                actionBtn.disabled = true;
            } else if (isClaimed) {
                actionBtn.textContent = 'Fjern √∏nske';
                actionBtn.disabled = false;
            } else if (book.claims.length >= MAX_CLAIMS_PER_BOOK) {
                actionBtn.textContent = 'Bogen er fuld (4/4)';
                actionBtn.disabled = true;
            } else {
                actionBtn.textContent = 'Jeg √∏nsker mig bogen her';
                actionBtn.disabled = false;
            }
            
            actionBtn.onclick = () => toggleClaim(bookId);
            
            // Show/hide admin image upload section
            const adminUploadSection = document.getElementById('adminImageUpload');
            if (isAdminMode) {
                adminUploadSection.classList.add('active');
                // Clear previous inputs
                document.getElementById('imageUrlInput').value = '';
                document.getElementById('imageFileInput').value = '';
                
                // Set current description in textarea
                document.getElementById('descriptionTextarea').value = book.desc;
                
                // Set Google Images search link
                const searchQuery = encodeURIComponent(`${book.title} ${book.author} bog forside`);
                const googleImagesLink = document.getElementById('googleImagesLink');
                googleImagesLink.href = `https://www.google.com/search?tbm=isch&q=${searchQuery}`;
            } else {
                adminUploadSection.classList.remove('active');
            }
            
            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('bookModal').classList.remove('active');
            currentBookId = null;
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function showError(message, type = 'error') {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.style.background = type === 'success' ? '#34c759' : '#ff3b30';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================
        // INITIALIZE ON LOAD
        // ============================================
        window.onload = init;
    </script>
</body>
</html>
