<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bogsnup 2026</title>
    <style>
        :root {
            --blue:   #007aff;
            --purple: #5856d6;
            --green:  #34c759;
            --red:    #ff3b30;
            --orange: #ff9500;
            --gold:   #ffd700;
            --bg:     #f0f2f5;
            --card:   #ffffff;
            --border: #e2e4e8;
            --text:   #1c1c1e;
            --muted:  #8e8e93;
            --r:      12px;
            --sh:     0 2px 12px rgba(0,0,0,.08);
        }

        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg); color: var(--text); min-height: 100vh;
        }

        /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        header {
            background: var(--card); border-bottom: 1px solid var(--border);
            position: sticky; top: 0; z-index: 200;
            box-shadow: 0 2px 8px rgba(0,0,0,.07);
        }
        .header-inner {
            display: flex; align-items: center; gap: 16px;
            padding: 16px 30px; max-width: 1600px; margin: 0 auto;
        }
        .logo { font-size: 22px; font-weight: 800; letter-spacing: -.4px; white-space: nowrap; }
        .logo small { font-size: 13px; font-weight: 400; color: var(--muted); margin-left: 6px; }

        .status-pill {
            display: flex; align-items: center; gap: 5px;
            font-size: 12px; font-weight: 600; padding: 5px 12px;
            border-radius: 20px; background: var(--green); color: #fff;
        }
        .status-pill::before {
            content: ''; width: 6px; height: 6px; border-radius: 50%;
            background: rgba(255,255,255,.8); animation: blink 2s infinite;
        }
        @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }
        .status-pill.offline { background: var(--red); }

        .guide-text {
            font-size: 13px; color: #555; line-height: 1.5;
            border-left: 3px solid var(--blue); padding-left: 10px;
        }

        .name-row {
            display: flex; gap: 8px; align-items: center; margin-left: auto;
        }
        .name-row input {
            padding: 9px 14px; border: 1.5px solid var(--border);
            border-radius: 9px; font-size: 14px; width: 200px;
            outline: none; transition: border-color .15s;
        }
        .name-row input:focus { border-color: var(--blue); }
        .btn-save {
            padding: 9px 20px; background: var(--blue); color: #fff;
            border: none; border-radius: 9px; font-size: 14px; font-weight: 600;
            cursor: pointer; transition: background .15s, transform .1s;
        }
        .btn-save:hover { background: #0062cc; }
        .btn-save:active { transform: scale(.96); }
        .btn-save.saved { background: var(--green); }

        /* â”€â”€ CONTROLS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .controls-bar {
            background: var(--card); border-bottom: 1px solid var(--border);
            padding: 10px 30px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
            max-width: 1600px; margin: 0 auto;
        }
        .btn-refresh {
            padding: 8px 18px; height: 40px; background: var(--purple); color: #fff;
            border: none; border-radius: 9px; font-size: 13px; font-weight: 600;
            cursor: pointer; transition: opacity .15s;
        }
        .btn-refresh:hover { opacity: .85; }

        #adminArea {
            display: none; align-items: center; gap: 8px;
            border-left: 2px solid var(--border); padding-left: 14px;
        }
        #adminArea input[type="password"] {
            padding: 8px 12px; border: 1.5px solid var(--border);
            border-radius: 8px; font-size: 13px; height: 40px; width: 120px;
        }
        .admin-btn {
            height: 40px; padding: 0 14px; background: var(--blue); color: #fff;
            border: none; border-radius: 8px; font-size: 13px; font-weight: 600;
            cursor: pointer; white-space: nowrap; transition: opacity .15s;
        }
        .admin-btn:disabled { opacity: .4; pointer-events: none; }
        .admin-btn:hover:not(:disabled) { opacity: .85; }
        .btn-ai { background: var(--purple); }

        /* Progress */
        .progress-wrap {
            display: none; padding: 8px 30px;
            background: var(--card); border-bottom: 1px solid var(--border);
        }
        .progress-track { height: 28px; background: #eee; border-radius: 8px; overflow: hidden; }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, var(--blue), var(--purple));
            transition: width .3s; display: flex; align-items: center;
            justify-content: center; color: #fff; font-size: 12px; font-weight: 700;
            min-width: 40px;
        }

        /* Toast */
        .toast {
            position: fixed; top: 80px; left: 50%;
            transform: translateX(-50%) translateY(-10px);
            background: #222; color: #fff; padding: 11px 22px; border-radius: 10px;
            font-size: 14px; font-weight: 500; z-index: 900; opacity: 0; pointer-events: none;
            transition: opacity .2s, transform .2s; box-shadow: 0 4px 20px rgba(0,0,0,.25);
            white-space: nowrap;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast.ok  { background: var(--green); }
        .toast.err { background: var(--red); }

        /* â”€â”€ BOOK GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .page-wrap { max-width: 1600px; margin: 0 auto; }
        .book-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px; padding: 24px 30px;
        }

        .book-card {
            background: var(--card); border-radius: var(--r); box-shadow: var(--sh);
            display: flex; flex-direction: column; overflow: hidden; cursor: pointer;
            transition: transform .18s, box-shadow .18s;
        }
        .book-card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(0,0,0,.13); }

        .card-cover {
            aspect-ratio: 2/3;
            background: linear-gradient(135deg, #e8eaf6, #c5cae9);
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        .card-cover img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .card-cover-ph { font-size: 44px; opacity: .3; }

        .card-body { padding: 12px; flex: 1; display: flex; flex-direction: column; }
        .card-title  { font-size: 13px; font-weight: 700; line-height: 1.3; margin-bottom: 3px; }
        .card-author { font-size: 12px; color: var(--muted); margin-bottom: 6px; flex: 1; }
        .card-hint   { font-size: 11px; color: var(--blue); font-style: italic; margin-bottom: 8px; }

        /* 6-slot grid: 3 columns Ã— 2 rows */
        .claim-slots {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 4px; margin-bottom: 10px;
        }
        .slot {
            padding: 4px 3px; background: var(--bg); border: 1px solid var(--border);
            border-radius: 5px; font-size: 10px; text-align: center;
            overflow: hidden; white-space: nowrap; text-overflow: ellipsis; color: var(--muted);
        }
        .slot.taken  { color: var(--text); font-weight: 600; background: #f0f4ff; border-color: #c5cfe8; }
        .slot.winner { background: var(--gold); border-color: #d4aa00; color: #000; font-weight: 700; }

        .btn-claim {
            width: 100%; padding: 9px; background: var(--blue); color: #fff;
            border: none; border-radius: 8px; font-size: 12px; font-weight: 600;
            cursor: pointer; transition: background .15s;
        }
        .btn-claim:hover:not(:disabled) { background: #0062cc; }
        .btn-claim.claimed { background: var(--red); }
        .btn-claim.claimed:hover { background: #cc2a1f; }
        .btn-claim:disabled { background: var(--border); color: var(--muted); cursor: default; }

        .win-badge {
            display: inline-block; background: var(--green); color: #fff;
            padding: 1px 6px; border-radius: 4px; font-size: 10px; font-weight: 700;
            margin-left: 4px; vertical-align: middle;
        }

        /* Empty state */
        .empty-state { grid-column: 1/-1; text-align: center; padding: 80px 20px; color: var(--muted); }
        .empty-state .icon { font-size: 56px; margin-bottom: 14px; }
        .empty-state p { font-size: 16px; }

        /* â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .modal-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,.5); z-index: 500;
            align-items: center; justify-content: center; padding: 20px;
        }
        .modal-overlay.active { display: flex; }

        .modal-box {
            background: var(--card); border-radius: var(--r);
            width: 100%; max-width: 520px; max-height: 88vh;
            overflow-y: auto; animation: fadeUp .2s ease;
            box-shadow: 0 20px 60px rgba(0,0,0,.2);
        }
        @keyframes fadeUp { from{opacity:0; transform:translateY(16px)} to{opacity:1; transform:none} }

        .modal-cover {
            width: 100%; max-height: 280px; object-fit: contain; display: block;
            background: linear-gradient(135deg, #e8eaf6, #c5cae9);
        }
        .modal-body { padding: 24px; }
        .modal-title  { font-size: 22px; font-weight: 800; margin-bottom: 4px; }
        .modal-author { font-size: 14px; color: var(--muted); margin-bottom: 18px; }
        .modal-desc {
            font-size: 14px; line-height: 1.65; color: #444;
            background: var(--bg); padding: 14px; border-radius: 10px;
            border: 1px solid var(--border); margin-bottom: 18px;
        }
        .modal-claims-lbl {
            font-size: 11px; font-weight: 700; text-transform: uppercase;
            letter-spacing: .6px; color: var(--muted); margin-bottom: 8px;
        }
        .claim-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 14px; background: var(--bg); border-radius: 8px;
            margin-bottom: 6px; font-size: 14px; border: 1px solid var(--border);
        }
        .claim-item.win { background: var(--gold); border-color: #d4aa00; font-weight: 700; }

        /* Admin section */
        .modal-admin {
            display: none; margin: 0 24px 24px; background: var(--bg);
            border-radius: 10px; border: 2px dashed var(--blue); padding: 18px;
        }
        .modal-admin.active { display: block; }
        .modal-admin h4 { font-size: 13px; color: var(--blue); margin-bottom: 10px; font-weight: 700; }
        .modal-admin a { font-size: 13px; color: var(--blue); display: block; margin-bottom: 10px; text-decoration: none; }
        .modal-admin a:hover { text-decoration: underline; }
        .modal-admin input[type="url"],
        .modal-admin textarea {
            width: 100%; padding: 9px 12px; border: 1.5px solid var(--border);
            border-radius: 8px; font-size: 13px; margin-bottom: 8px;
            font-family: inherit; resize: vertical; outline: none;
            transition: border-color .15s;
        }
        .modal-admin input[type="url"]:focus,
        .modal-admin textarea:focus { border-color: var(--blue); }
        .modal-admin input[type="file"] { font-size: 13px; margin-bottom: 10px; display: block; }
        .adm-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .adm-btn {
            flex: 1; padding: 9px 12px; background: var(--blue); color: #fff;
            border: none; border-radius: 8px; font-size: 13px; font-weight: 600;
            cursor: pointer; transition: opacity .15s;
        }
        .adm-btn:hover { opacity: .85; }
        .adm-btn.red { background: var(--red); }
        .adm-btn.ora { background: var(--orange); }
        .modal-sep { border: none; border-top: 1px solid var(--border); margin: 16px 0; }

        .modal-footer {
            display: flex; gap: 10px; padding: 18px 24px;
            border-top: 1px solid var(--border);
            position: sticky; bottom: 0; background: var(--card);
        }
        .modal-footer button {
            flex: 1; padding: 13px; border: none; border-radius: 10px;
            font-size: 15px; font-weight: 600; cursor: pointer; transition: opacity .15s;
        }
        .modal-footer button:hover { opacity: .85; }
        .btn-ma { background: var(--blue); color: #fff; }
        .btn-ma.claimed { background: var(--red); }
        .btn-mc { background: var(--bg); color: var(--text); border: 1px solid var(--border); }
    </style>
</head>
<body>

<!-- HEADER -->
<header>
    <div class="header-inner">
        <div class="logo">ğŸ“š Bogsnup <small>âš¡ Real-time</small></div>
        <span class="status-pill" id="firebaseStatus">Forbinderâ€¦</span>
        <div class="guide-text">
            1. Skriv dit navn og tryk <strong>GEM</strong>. &nbsp;
            2. Klik pÃ¥ en bog for info. &nbsp;
            3. Tryk <em>"Jeg Ã¸nsker mig bogen"</em>. &nbsp;
            <em style="color:var(--muted)">Regel: Du kan vinde flere bÃ¸ger hvis du er den eneste der Ã¸nsker dem, men kun Ã©n bog hvor der er konkurrence.</em>
        </div>
        <div class="name-row">
            <input type="text" id="userName" placeholder="Dit navn" autocomplete="given-name">
            <button class="btn-save" id="saveNameBtn" onclick="saveUserName()">GEM</button>
        </div>
    </div>
</header>

<!-- CONTROLS -->
<div class="controls-bar">
    <button class="btn-refresh" onclick="manualRefresh()">ğŸ”„ GenindlÃ¦s</button>
    <div id="adminArea">
        <input type="password" id="adminPass" placeholder="Admin-kode">
        <button class="admin-btn" onclick="toggleAdmin()">ğŸ”“ Login</button>
        <input type="file" id="csvFileInput" accept=".csv" style="display:none" onchange="handleCSVUpload(event)">
        <button class="admin-btn" id="btnUpload" disabled onclick="document.getElementById('csvFileInput').click()">ğŸ“ CSV</button>
        <button class="admin-btn btn-ai" id="btnFetch" disabled onclick="fetchAllInfo()">âœ¨ Hent info</button>
        <button class="admin-btn" id="btnErrors" disabled onclick="showFetchErrors()">âš ï¸ Vis fejl</button>
        <button class="admin-btn" id="btnDebug" disabled style="background:var(--purple)" onclick="debugFirebase()">ğŸ” Debug</button>
        <button class="admin-btn" id="btnLottery" disabled onclick="runSmartLottery()">ğŸ² LodtrÃ¦kning</button>
        <button class="admin-btn" id="btnReset" disabled style="background:var(--red)" onclick="clearAllData()">ğŸ—‘ï¸ Slet Alt</button>
    </div>
</div>

<!-- Progress -->
<div class="progress-wrap" id="progressContainer">
    <div class="progress-track">
        <div class="progress-fill" id="progressBar" style="width:0%">0%</div>
    </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- GRID -->
<div class="page-wrap">
    <div class="book-grid" id="bookGrid"></div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="bookModal">
    <div class="modal-box">
        <img id="modalImg" class="modal-cover" src="" alt="" style="display:none">
        <div class="modal-body">
            <div class="modal-title"  id="modalTitle"></div>
            <div class="modal-author" id="modalAuthor"></div>
            <div class="modal-desc"   id="modalDesc"></div>
            <div class="modal-claims-lbl">Ã˜nsker (maks 6)</div>
            <div id="modalClaims"></div>
        </div>

        <div class="modal-admin" id="adminImageUpload">
            <h4>ğŸ“¸ Forside (Admin)</h4>
            <a id="googleImagesLink" href="#" target="_blank">ğŸ” SÃ¸g pÃ¥ Google Images</a>
            <input type="url" id="imageUrlInput" placeholder="Billede-URL (https://â€¦)">
            <div class="adm-row">
                <button class="adm-btn" onclick="uploadImageFromUrl()">Gem URL</button>
                <button class="adm-btn red" onclick="removeBookCover()">Fjern billede</button>
            </div>
            <input type="file" id="imageFileInput" accept="image/*">
            <button class="adm-btn" style="width:100%;margin-bottom:14px" onclick="uploadImageFromFile()">Upload fil</button>
            <hr class="modal-sep">
            <h4>âœï¸ Beskrivelse (Admin)</h4>
            <textarea id="descriptionTextarea" rows="5" placeholder="Skriv beskrivelseâ€¦"></textarea>
            <div class="adm-row">
                <button class="adm-btn" onclick="saveManualDescription()">Gem beskrivelse</button>
                <button class="adm-btn ora" onclick="clearDescription()">Nulstil</button>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn-ma" id="modalActionButton" onclick="handleModalClaim()"></button>
            <button class="btn-mc" onclick="closeModal()">Luk</button>
        </div>
    </div>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const firebaseConfig = {
    apiKey: "AIzaSyB-2_DMuUGVgckSMGMrdUaKVVQQ7hhCTvU",
    authDomain: "bogsnup2026.firebaseapp.com",
    databaseURL: "https://bogsnup2026-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "bogsnup2026",
    storageBucket: "bogsnup2026.firebasestorage.app",
    messagingSenderId: "751291661929",
    appId: "1:751291661929:web:40a3ab1793184d6718acf8",
    measurementId: "G-3L1D4R8HXT"
};

let database, isFirebaseReady = false;
try {
    firebase.initializeApp(firebaseConfig);
    database = firebase.database();
    isFirebaseReady = true;
    setStatus(true);
    database.ref('.info/connected').on('value', s => setStatus(s.val() === true));
} catch(e) {
    console.error(e);
    setStatus(false);
    alert('âš ï¸ Firebase fejl: ' + e.message);
}

function setStatus(ok) {
    const el = document.getElementById('firebaseStatus');
    el.textContent = ok ? 'Forbundet' : 'Offline';
    el.className = 'status-pill' + (ok ? '' : ' offline');
}

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const USER_KEY   = 'shufflerUserName';
const ADMIN_PW   = 'Bogsnup2026';
const MAX_CLAIMS = 6;   // â† 6 slots
const API_DELAY  = 500;

let books = [], currentBookId = null, isAdminMode = false;

// â”€â”€ NAME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getUser() { return document.getElementById('userName').value.trim(); }

function saveUserName() {
    const v = getUser();
    if (!v) { toast('Skriv dit navn', 'err'); return; }
    localStorage.setItem(USER_KEY, v);
    const btn = document.getElementById('saveNameBtn');
    btn.textContent = 'âœ“ Gemt'; btn.classList.add('saved');
    setTimeout(() => { btn.textContent = 'GEM'; btn.classList.remove('saved'); }, 2000);
    renderBooks();
}

// â”€â”€ FIREBASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupFirebaseListeners() {
    database.ref('books').on('value', snap => {
        const data = snap.val();
        books = data ? Object.keys(data).map(k => ({ firebaseKey: k, ...data[k] })) : [];
        renderBooks();
        if (currentBookId) {
            const b = books.find(b => b.id === currentBookId);
            if (b) updateModalContent(b);
        }
    });
}

async function saveBookToFirebase(book) {
    if (!isFirebaseReady) return;
    try {
        if (book.firebaseKey) {
            await database.ref('books/' + book.firebaseKey).set(book);
        } else {
            const r = await database.ref('books').push(book);
            book.firebaseKey = r.key;
        }
    } catch(e) { toast('Gemningsfejl: ' + e.message, 'err'); }
}

async function saveAllBooksToFirebase(arr) {
    if (!isFirebaseReady) { toast('Firebase ikke klar', 'err'); return false; }
    try {
        const upd = {};
        arr.forEach(book => {
            const key = book.firebaseKey || database.ref('books').push().key;
            const d = { ...book }; delete d.firebaseKey;
            upd['/books/' + key] = d;
        });
        await database.ref().update(upd);
        toast(`âœ… ${arr.length} bÃ¸ger gemt`, 'ok');
        return true;
    } catch(e) { toast('Fejl: ' + e.message, 'err'); return false; }
}

async function deleteAllBooksFromFirebase() {
    await database.ref('books').remove();
    books = []; renderBooks();
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function init() {
    const saved = localStorage.getItem(USER_KEY);
    if (saved) document.getElementById('userName').value = saved;

    document.addEventListener('keydown', e => {
        if (e.shiftKey && e.key === 'L')
            document.getElementById('adminArea').style.display = 'flex';
    });
    document.getElementById('bookModal').addEventListener('click', e => {
        if (e.target.id === 'bookModal') closeModal();
    });

    if (isFirebaseReady) {
        setupFirebaseListeners();
    } else {
        let n = 0;
        const iv = setInterval(() => {
            if (isFirebaseReady) { clearInterval(iv); setupFirebaseListeners(); }
            else if (++n >= 50)  { clearInterval(iv); toast('Firebase timeout', 'err'); }
        }, 100);
    }
}

// â”€â”€ ADMIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleAdmin() {
    if (document.getElementById('adminPass').value === ADMIN_PW) {
        isAdminMode = true;
        document.querySelectorAll('.admin-btn').forEach(b => b.disabled = false);
        toast('Admin aktiveret âœ…', 'ok');
    } else { toast('Forkert adgangskode', 'err'); }
}

function handleCSVUpload(event) {
    const file = event.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = async e => {
        try {
            const lines = e.target.result.split('\n').filter(l => l.trim());
            if (lines.length < 2) { toast('CSV skal have mindst 2 linjer', 'err'); return; }
            const newBooks = lines.slice(1).map((line, i) => {
                const p = line.split(/[;,]/).map(s => s.trim());
                return {
                    id: 'b-' + Date.now() + '-' + i,
                    title: p[0] || 'Ingen titel',
                    author: p[1] || 'Ukendt forfatter',
                    desc: 'Brug "Hent info" for at hente beskrivelse fra Google Books.',
                    cover: '', claims: [], winner: null,
                    fetchAttempted: false, fetchSuccess: false,
                    manualCover: false, manualDesc: false
                };
            });
            await saveAllBooksToFirebase(newBooks);
        } catch(err) { toast('CSV fejl: ' + err.message, 'err'); }
    };
    reader.readAsText(file);
    event.target.value = '';
}

async function fetchAllInfo() {
    if (!books.length) { toast('Upload en CSV-fil fÃ¸rst', 'err'); return; }
    const btn  = document.getElementById('btnFetch');
    const wrap = document.getElementById('progressContainer');
    const bar  = document.getElementById('progressBar');
    btn.disabled = true; btn.textContent = 'â³ Henterâ€¦';
    wrap.style.display = 'block';
    let ok = 0, fail = 0;
    for (let i = 0; i < books.length; i++) {
        const book = books[i];
        const pct = Math.round(((i + 1) / books.length) * 100);
        bar.style.width = pct + '%';
        bar.textContent = `${i + 1}/${books.length} â€“ ${book.title}`;
        if (book.manualCover && book.manualDesc) { await delay(100); continue; }
        try {
            const queries = [
                `intitle:"${book.title}" inauthor:"${book.author}"`,
                `${book.title} ${book.author}`,
                book.title
            ];
            let found = false;
            for (const q of queries) {
                if (found) break;
                try {
                    const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(q)}&langRestrict=da&maxResults=3`);
                    if (!res.ok) throw new Error('HTTP ' + res.status);
                    const data = await res.json();
                    if (data.items?.length) {
                        let best = data.items[0];
                        for (const item of data.items)
                            if (item.volumeInfo.title?.toLowerCase().includes(book.title.toLowerCase())) { best = item; break; }
                        const info = best.volumeInfo;
                        if (!book.manualDesc) book.desc = info.description || info.subtitle || 'Ingen beskrivelse fra Google Books.';
                        if (!book.manualCover && info.imageLinks)
                            book.cover = (info.imageLinks.large || info.imageLinks.medium || info.imageLinks.thumbnail || '').replace('http:', 'https:');
                        if (info.authors?.length) book.author = info.authors.join(', ');
                        book.fetchSuccess = true; found = true; ok++;
                    }
                } catch {}
            }
            if (!found) { book.fetchError = 'Ikke fundet'; fail++; }
            book.fetchAttempted = true;
            await saveBookToFirebase(book);
            if (i < books.length - 1) await delay(API_DELAY);
        } catch(err) {
            book.fetchError = err.message; book.fetchAttempted = true; fail++;
            await saveBookToFirebase(book); await delay(800);
        }
    }
    btn.disabled = false; btn.textContent = 'âœ¨ Hent info';
    wrap.style.display = 'none';
    toast(fail ? `âœ… ${ok} ok â€” âŒ ${fail} fejlede` : `ğŸ‰ Alle ${ok} bÃ¸ger hentet!`, fail && ok === 0 ? 'err' : 'ok');
}

function showFetchErrors() {
    const failed = books.filter(b => b.fetchAttempted && !b.fetchSuccess);
    if (!failed.length) { toast('Ingen fejl!', 'ok'); return; }
    alert(`âŒ ${failed.length} fejlede:\n\n` + failed.map(b => `â€¢ "${b.title}"\n  ${b.fetchError || 'Ikke fundet'}`).join('\n\n'));
}

async function debugFirebase() {
    let r = 'ğŸ” Firebase Debug\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
    r += `Init: ${isFirebaseReady ? 'âœ…' : 'âŒ'}\nLokale bÃ¸ger: ${books.length}\n`;
    if (isFirebaseReady) {
        try {
            const snap = await database.ref('books').once('value');
            r += `Firebase bÃ¸ger: ${snap.val() ? Object.keys(snap.val()).length : 0}\n`;
            await database.ref('test').set({ ts: Date.now() });
            r += 'Skriveadgang: âœ…\n';
            await database.ref('test').remove();
        } catch(e) { r += 'Fejl: ' + e.message + '\n'; }
    }
    alert(r);
}

async function manualRefresh() {
    if (!isFirebaseReady) { toast('Firebase ikke forbundet', 'err'); return; }
    const snap = await database.ref('books').once('value');
    const data = snap.val();
    books = data ? Object.keys(data).map(k => ({ firebaseKey: k, ...data[k] })) : [];
    renderBooks();
    toast(`âœ… ${books.length} bÃ¸ger genindlÃ¦st`, 'ok');
}

async function runSmartLottery() {
    if (!books.length) { toast('Ingen bÃ¸ger', 'err'); return; }
    const total = books.reduce((s, b) => s + (b.claims?.length || 0), 0);
    if (!total) { toast('Ingen Ã¸nsker endnu', 'err'); return; }
    if (!confirm(`KÃ¸r lodtrÃ¦kning for ${books.length} bÃ¸ger (${total} Ã¸nsker i alt)?`)) return;

    books.forEach(b => b.winner = null);

    // Step 1: Solo books â€” only one person wants them, they win automatically
    books.forEach(b => { if (b.claims?.length === 1) b.winner = b.claims[0]; });

    // Step 2: Competitive books (2+ claimants), processed in random order
    const popular = books.filter(b => b.claims?.length > 1);
    shuffleArray(popular);

    // Track who has won a competitive book (for the primary rule)
    const wonCompetitive = new Set();

    popular.forEach(b => {
        // Primary rule: prefer people who haven't won a competitive book yet
        const eligible = b.claims.filter(u => !wonCompetitive.has(u));

        if (eligible.length > 0) {
            // Happy path â€” pick randomly among those without a competitive win
            const win = eligible[Math.floor(Math.random() * eligible.length)];
            b.winner = win;
            wonCompetitive.add(win);
        } else {
            // Fallback: everyone here has already won a competitive book.
            // Be fair by preferring whoever has won the fewest books in total
            // (solo wins + competitive wins combined).
            const totalWins = user => books.filter(bk => bk.winner === user).length;
            const minWins = Math.min(...b.claims.map(totalWins));
            const leastWinners = b.claims.filter(u => totalWins(u) === minWins);
            const win = leastWinners[Math.floor(Math.random() * leastWinners.length)];
            b.winner = win;
            wonCompetitive.add(win);
        }
    });

    await saveAllBooksToFirebase(books);
    const winners = new Set(books.filter(b => b.winner).map(b => b.winner));
    toast(`ğŸ‰ ${books.filter(b => b.winner).length} bÃ¸ger tildelt til ${winners.size} vindere`, 'ok');
}

async function clearAllData() {
    if (!confirm('Slet ALLE data? Kan ikke fortrydes!')) return;
    if (!confirm('BekrÃ¦ft: slet alt permanent')) return;
    await deleteAllBooksFromFirebase();
    toast('Alle data slettet', 'ok');
}

// â”€â”€ CLAIMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function toggleClaim(bookId) {
    const user = getUser();
    if (!user) { toast('Skriv og GEM dit navn fÃ¸rst', 'err'); return; }
    const book = books.find(b => b.id === bookId); if (!book) return;
    if (!book.claims) book.claims = [];
    const idx = book.claims.indexOf(user);
    if (idx > -1) {
        book.claims.splice(idx, 1);
        if (book.winner === user) book.winner = null;
    } else {
        if (book.claims.length >= MAX_CLAIMS) { toast(`Bogen har allerede ${MAX_CLAIMS} Ã¸nsker`, 'err'); return; }
        book.claims.push(user);
    }
    await saveBookToFirebase(book);
}
function handleModalClaim() { if (currentBookId) toggleClaim(currentBookId); }

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBooks() {
    const grid = document.getElementById('bookGrid');
    const user = getUser();
    if (!books.length) {
        grid.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“š</div><p>Ingen bÃ¸ger endnu â€” upload en CSV-fil (admin) for at starte.</p></div>';
        return;
    }
    grid.innerHTML = '';
    books.forEach(book => grid.appendChild(createBookCard(book, user)));
}

function createBookCard(book, user) {
    const card = document.createElement('div');
    card.className = 'book-card';
    card.onclick = () => openModal(book.id);

    const claims    = book.claims || [];
    const isClaimed = user && claims.includes(user);
    const isWinner  = book.winner === user;

    // 6 slots in a 3Ã—2 grid
    const slots = Array(MAX_CLAIMS).fill(0).map((_, i) => {
        const c = claims[i];
        const w = book.winner === c && c;
        return `<div class="slot${c ? ' taken' : ''}${w ? ' winner' : ''}">${c ? c.split(' ')[0] : 'â€“'}${w ? ' ğŸ†' : ''}</div>`;
    }).join('');

    let btnCls = 'btn-claim', btnTxt = 'Jeg Ã¸nsker mig bogen her', dis = false;
    if (!user)                         { btnTxt = 'Skriv navn fÃ¸rst'; dis = true; }
    else if (isClaimed)                { btnCls += ' claimed'; btnTxt = 'Fjern Ã¸nske'; }
    else if (claims.length >= MAX_CLAIMS) { btnTxt = `Fuld (${MAX_CLAIMS}/${MAX_CLAIMS})`; dis = true; }

    card.innerHTML = `
        <div class="card-cover">
            ${book.cover
                ? `<img src="${esc(book.cover)}" alt="${esc(book.title)}" loading="lazy" onerror="this.parentNode.innerHTML='<div class=card-cover-ph>ğŸ“–</div>'">`
                : `<div class="card-cover-ph">ğŸ“–</div>`}
        </div>
        <div class="card-body">
            <div class="card-title">${esc(book.title)}${isWinner ? '<span class="win-badge">ğŸ† DIN</span>' : ''}</div>
            <div class="card-author">${esc(book.author)}</div>
            <div class="card-hint">â„¹ï¸ Klik for beskrivelse</div>
            <div class="claim-slots">${slots}</div>
            <button class="${btnCls}" ${dis ? 'disabled' : ''} onclick="event.stopPropagation();toggleClaim('${book.id}')">${btnTxt}</button>
        </div>`;
    return card;
}

// â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(bookId) {
    currentBookId = bookId;
    const book = books.find(b => b.id === bookId); if (!book) return;
    updateModalContent(book);
    document.getElementById('bookModal').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function updateModalContent(book) {
    const user = getUser();
    const img  = document.getElementById('modalImg');
    img.src = book.cover || ''; img.style.display = book.cover ? 'block' : 'none';
    document.getElementById('modalTitle').textContent  = book.title;
    document.getElementById('modalAuthor').textContent = book.author;
    document.getElementById('modalDesc').textContent   = book.desc || 'Ingen beskrivelse.';

    const claims = book.claims || [];
    document.getElementById('modalClaims').innerHTML = claims.length
        ? claims.map(c => `
            <div class="claim-item${book.winner === c ? ' win' : ''}">
                <span>${esc(c)}</span>
                ${book.winner === c ? '<span>ğŸ† VINDER</span>' : ''}
            </div>`).join('')
        : '<p style="color:var(--muted);font-style:italic;font-size:14px;padding:6px 0">Ingen Ã¸nsker endnu</p>';

    const btn = document.getElementById('modalActionButton');
    const isClaimed = user && claims.includes(user);
    if (!user)                            { btn.textContent = 'Skriv dit navn fÃ¸rst'; btn.disabled = true; btn.className = 'btn-ma'; }
    else if (isClaimed)                   { btn.textContent = 'Fjern Ã¸nske'; btn.disabled = false; btn.className = 'btn-ma claimed'; }
    else if (claims.length >= MAX_CLAIMS) { btn.textContent = `Fuld (${MAX_CLAIMS}/${MAX_CLAIMS})`; btn.disabled = true; btn.className = 'btn-ma'; }
    else                                  { btn.textContent = 'Jeg Ã¸nsker mig bogen her'; btn.disabled = false; btn.className = 'btn-ma'; }

    const adm = document.getElementById('adminImageUpload');
    if (isAdminMode) {
        adm.classList.add('active');
        document.getElementById('imageUrlInput').value = '';
        document.getElementById('imageFileInput').value = '';
        document.getElementById('descriptionTextarea').value = book.desc || '';
        const q = encodeURIComponent(`${book.title} ${book.author} bog forside`);
        document.getElementById('googleImagesLink').href = `https://www.google.com/search?tbm=isch&q=${q}`;
    } else { adm.classList.remove('active'); }
}

function closeModal() {
    document.getElementById('bookModal').classList.remove('active');
    document.body.style.overflow = '';
    currentBookId = null;
}

// â”€â”€ ADMIN IMAGE / DESC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function uploadImageFromUrl() {
    if (!currentBookId) return;
    const url = document.getElementById('imageUrlInput').value.trim();
    if (!url.startsWith('http')) { toast('Ugyldig URL', 'err'); return; }
    const book = books.find(b => b.id === currentBookId);
    book.cover = url; book.manualCover = true;
    await saveBookToFirebase(book);
    const img = document.getElementById('modalImg');
    img.src = url; img.style.display = 'block';
    document.getElementById('imageUrlInput').value = '';
    toast('Forside opdateret!', 'ok');
}
async function uploadImageFromFile() {
    if (!currentBookId) return;
    const file = document.getElementById('imageFileInput').files[0];
    if (!file) { toast('VÃ¦lg en fil', 'err'); return; }
    if (file.size > 2 * 1024 * 1024) { toast('Maks 2MB', 'err'); return; }
    const reader = new FileReader();
    reader.onload = async e => {
        const book = books.find(b => b.id === currentBookId);
        book.cover = e.target.result; book.manualCover = true;
        await saveBookToFirebase(book);
        const img = document.getElementById('modalImg');
        img.src = e.target.result; img.style.display = 'block';
        toast('Billede uploadet!', 'ok');
    };
    reader.readAsDataURL(file);
}
async function removeBookCover() {
    if (!currentBookId || !confirm('Fjern forsidebillede?')) return;
    const book = books.find(b => b.id === currentBookId);
    book.cover = ''; book.manualCover = false;
    await saveBookToFirebase(book);
    document.getElementById('modalImg').style.display = 'none';
    toast('Forside fjernet', 'ok');
}
async function saveManualDescription() {
    if (!currentBookId) return;
    const desc = document.getElementById('descriptionTextarea').value.trim();
    if (!desc) { toast('Skriv en beskrivelse', 'err'); return; }
    const book = books.find(b => b.id === currentBookId);
    book.desc = desc; book.manualDesc = true;
    await saveBookToFirebase(book);
    document.getElementById('modalDesc').textContent = desc;
    toast('Beskrivelse gemt!', 'ok');
}
async function clearDescription() {
    if (!currentBookId || !confirm('Nulstil beskrivelse?')) return;
    const book = books.find(b => b.id === currentBookId);
    book.desc = 'Brug "Hent info" for at hente beskrivelse fra Google Books.';
    book.manualDesc = false;
    await saveBookToFirebase(book);
    document.getElementById('modalDesc').textContent = book.desc;
    document.getElementById('descriptionTextarea').value = book.desc;
    toast('Nulstillet', 'ok');
}

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let toastTimer;
function toast(msg, type = '') {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.className = 'toast show' + (type ? ' ' + type : '');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => el.classList.remove('show'), 3500);
}
function delay(ms) { return new Promise(r => setTimeout(r, ms)); }
function shuffleArray(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
}
function esc(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

window.onload = init;
</script>
</body>
</html>
